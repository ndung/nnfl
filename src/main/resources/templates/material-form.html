<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout (~{::body},'index')}">
<body>
<div class="kt-container-fluid px=0">
    <div class="grid grid-cols-1 gap-5">

        <div th:replace="~{cards/general-info :: generalInfoCard}"></div>

        <th:block th:if="${stage == 1}">
            <div th:replace="~{cards/geology :: geologyCard}"></div>
        </th:block>

        <th:block th:if="${stage == 2 or stage == 3}">
            <div th:replace="~{cards/chemical-form :: chemicalCard}"></div>
        </th:block>

        <th:block th:if="${stage == 1}">
            <div th:replace="~{cards/mineralogy :: mineralogyCard}"></div>
        </th:block>

        <th:block th:if="${stage == 2 or stage == 3}">
            <div th:replace="~{cards/physical :: physicalCard}"></div>
        </th:block>

        <th:block th:if="${stage == 2 or stage == 3}">
            <div th:replace="~{cards/morphology :: morphologyCard}"></div>
        </th:block>

        <th:block th:if="${stage == 1 or stage == 2}">
            <div th:replace="~{cards/uranium :: uraniumCard}"></div>
        </th:block>

        <th:block th:if="${stage == 1 or stage == 2}">
            <div th:replace="~{cards/uranium-isotope :: uraniumIsotopeCard}"></div>
        </th:block>

        <th:block th:if="${stage == 2}">
            <div th:replace="~{cards/decay :: uraniumDecayCard}"></div>
        </th:block>

        <th:block th:if="${stage == 1 or stage == 2}">
            <div th:replace="~{cards/stable-isotope :: stableIsotopeCard}"></div>
        </th:block>

        <th:block th:if="${stage == 1 or stage == 2}">
            <div th:replace="~{cards/trace-element :: traceElementCard}"></div>
        </th:block>

        <th:block th:if="${stage == 2}">
            <div th:replace="~{cards/process-info :: processInfoCard}"></div>
        </th:block>

        <div th:replace="~{cards/element :: elementCard}"></div>
        <div th:replace="~{cards/container :: containerCard}"></div>
        <div th:replace="~{cards/irradiation :: irradiationCard}"></div>
        <div th:replace="~{cards/isotope-activity :: isotopeActivityCard}"></div>
        <div th:replace="~{cards/serial-number :: serialNumberCard}"></div>
        <div th:replace="~{cards/source-activity-info :: sourceActivityInfoCard}"></div>
        <div th:replace="~{cards/source-description :: sourceDescriptionCard}"></div>

    </div>
</div>

<div th:replace="~{dialogs/chemical-form :: chemicalDialog}"></div>
<div th:replace="~{dialogs/uranium :: uraniumDialog}"></div>
<div th:replace="~{dialogs/uranium-isotope :: uraniumIsotopeDialog}"></div>
<div th:replace="~{dialogs/stable-isotope :: stableIsotopeDialog}"></div>
<div th:replace="~{dialogs/trace-element :: traceElementDialog}"></div>
<div th:replace="~{dialogs/element :: elementDialog}"></div>
<div th:replace="~{dialogs/morphology :: morphologyDialog}"></div>
<div th:replace="~{dialogs/decay :: uraniumDecayDialog}"></div>
<div th:replace="~{dialogs/container :: containerDialog}"></div>
<div th:replace="~{dialogs/general-info :: generalInfoDialog}"></div>
<div th:replace="~{dialogs/geology :: geologyDialog}"></div>
<div th:replace="~{dialogs/irradiation :: irradiationDialog}"></div>
<div th:replace="~{dialogs/isotope-activity :: isotopeActivityDialog}"></div>
<div th:replace="~{dialogs/mineralogy :: mineralogyDialog}"></div>
<div th:replace="~{dialogs/physical :: physicalDialog}"></div>
<div th:replace="~{dialogs/process-info :: processInfoDialog}"></div>
<div th:replace="~{dialogs/serial-number :: serialNumberDialog}"></div>
<div th:replace="~{dialogs/source-activity-info :: sourceActivityInfoDialog}"></div>
<div th:replace="~{dialogs/source-description :: sourceDescriptionDialog}"></div>


<link rel="stylesheet" th:href="@{https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css}" />
<script th:src="@{https://code.jquery.com/jquery-3.7.1.min.js}"></script>
<script th:src="@{https://code.jquery.com/ui/1.13.2/jquery-ui.js}"></script>
<script>
    $(function(){
        var materialId = window.location.pathname.split('/')[3];
        var stage = window.location.pathname.split('/')[4];
        var csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        var csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

        function init(dialogId, addBtnId, saveBtnId, tableId, getData, setData, endpoint, getJsonData){
            var currentRow = null;
            $(dialogId).dialog({ autoOpen:false, modal:true, width:640 });
            $(addBtnId).click(function(){ currentRow=null; $(dialogId).dialog('open'); });
            $(tableId).on('click','.editRow', function(){
                currentRow = $(this).closest('tr');
                var values = currentRow.children('td').slice(0,-1).map(function(){ return $(this).text(); }).get();
                setData(values);
                $(dialogId).dialog('open');
            });
            $(saveBtnId).click(function(){
                var data = getData();
                var payload = getJsonData ? getJsonData() : data;
                var headers = {'Content-Type':'application/json'};
                if (csrfToken) {
                    headers[csrfHeader || 'X-CSRF-TOKEN'] = csrfToken;
                }
                fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload),
                    credentials: 'same-origin'
                })
                    .then(res => {
                        if (res.ok) {               // server sent 3xx (e.g., 303 See Other)
                            window.location.reload();
                        }
                        if (!res.ok) {
                            alert(res.status + ' ' + res.statusText);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Save failed: ' + err.message);
                    });
                $(dialogId).dialog('close');
                $(dialogId + ' input').val('');
            });
        }

        init('#chemicalDialog','#addChemical','#saveChemical','#chemicalTable', function(){
            return [
                $('#chemicalId').val(),
                $('#chemicalStage').val(),
                $('#chemicalName').val(),
                $('#chemicalDeviation').val(),
                $('#chemicalComment').val()];
        }, function(v){
            $('#chemicalId').val(v[0].trim());
            $('#chemicalStage').val(v[1].trim());
            $('#chemicalName').val(v[2].trim());
            $('#chemicalDeviation').val(v[3].trim());
            $('#chemicalComment').val(v[4].trim());
        }, '/chemical-form/' + materialId + '/' + stage, function(){
            return {
                id: $('#chemicalId').val(),
                compoundName: $('#chemicalName').val(),
                stoichiometryDeviation: parseFloat($('#chemicalDeviation').val() || 0),
                notes: $('#chemicalComment').val()
            };
        });

        init('#uraniumDialog','#addUranium','#saveUranium','#uraniumTable', function(){
            return [
                $('#uraniumId').val(),
                $('#uraniumStage').val(),
                $('#uraniumName').val(),
                $('#uraniumConcentration').val(),
                $('#uraniumUnit').val(),
                $('#uraniumUncertainty').val(),
                $('#uraniumBurnablePoison').val(),
                $('#uraniumComment').val()];
        }, function(v){
            $('#uraniumId').val(v[0].trim());
            $('#uraniumStage').val(v[1].trim());
            $('#uraniumName').val(v[2].trim());
            $('#uraniumConcentration').val(v[3].trim());
            $('#uraniumUnit').val(v[4].trim());
            $('#uraniumUncertainty').val(v[5].trim());
            $('#uraniumBurnablePoison').val(v[6].trim());
            $('#uraniumComment').val(v[7].trim());
        }, '/uranium/' + materialId + '/' + stage, function(){
            return {
                id: $('#uraniumId').val(),
                element: $('#uraniumName').val(),
                concentration: parseFloat($('#uraniumConcentration').val() || 0),
                unit: $('#uraniumUnit').val(),
                uncertainty: parseFloat($('#uraniumUncertainty').val() || 0),
                burnablePoison: $('#uraniumBurnablePoison').val(),
                notes: $('#uraniumComment').val()
            };
        });

        init('#uraniumIsotopeDialog','#addUraniumIsotope','#saveUraniumIsotope','#uraniumIsotopeTable', function(){
            return [
                $('#uraniumIsotopeId').val(),
                $('#uraniumIsotopeStage').val(),
                $('#uraniumIsotopeName').val(),
                $('#uraniumIsotopeRatio').val(),
                $('#uraniumIsotopeUncertainty').val(),
                $('#uraniumIsotopeUnit').val(),
                $('#uraniumIsotopeComment').val()];
        }, function(v){
            $('#uraniumIsotopeId').val(v[0].trim());
            $('#uraniumIsotopeStage').val(v[1].trim());
            $('#uraniumIsotopeName').val(v[2].trim());
            $('#uraniumIsotopeRatio').val(v[3].trim());
            $('#uraniumIsotopeUncertainty').val(v[4].trim());
            $('#uraniumIsotopeUnit').val(v[5].trim());
            $('#uraniumIsotopeComment').val(v[6].trim());
        }, '/uranium-isotope/' + materialId + '/' + stage, function(){
            return {
                id: $('#uraniumIsotopeId').val(),
                name: $('#uraniumIsotopeName').val(),
                value: parseFloat($('#uraniumIsotopeRatio').val() || 0),
                uncertainty: parseFloat($('#uraniumIsotopeUncertainty').val() || 0),
                unit: $('#uraniumIsotopeUnit').val(),
                notes: $('#uraniumIsotopeComment').val()
            };
        })

        init('#stableIsotopeDialog','#addStableIsotope','#saveStableIsotope','#stableIsotopeTable', function(){
            return [
                $('#stableIsotopeId').val(),
                $('#stableIsotopeStage').val(),
                $('#stableIsotopeName').val(),
                $('#stableIsotopeRatio').val(),
                $('#stableIsotopeUncertainty').val(),
                $('#stableIsotopeUnit').val(),
                $('#stableIsotopeComment').val()];
        }, function(v){
            $('#stableIsotopeId').val(v[0].trim());
            $('#stableIsotopeStage').val(v[1].trim());
            $('#stableIsotopeName').val(v[2].trim());
            $('#stableIsotopeRatio').val(v[3].trim());
            $('#stableIsotopeUncertainty').val(v[4].trim());
            $('#stableIsotopeUnit').val(v[5].trim());
            $('#stableIsotopeComment').val(v[6].trim());
        }, '/stable-isotope/' + materialId + '/' + stage, function(){
            return {
                id: $('#stableIsotopeId').val(),
                name: $('#stableIsotopeName').val(),
                value: parseFloat($('#stableIsotopeRatio').val() || 0),
                uncertainty: parseFloat($('#stableIsotopeUncertainty').val() || 0),
                unit: $('#stableIsotopeUnit').val(),
                notes: $('#stableIsotopeComment').val()
            };
        });

        init('#traceElementDialog','#addTraceElement','#saveTraceElement','#traceElementTable', function(){
            return [
                $('#traceElementId').val(),
                $('#traceElementStage').val(),
                $('#traceElementName').val(),
                $('#traceElementConcentration').val(),
                $('#traceElementUnit').val(),
                $('#traceElementUncertainty').val(),
                $('#traceElementBurnablePoison').val(),
                $('#traceElementComment').val()];
        }, function(v){
            $('#traceElementId').val(v[0].trim());
            $('#traceElementStage').val(v[1].trim());
            $('#traceElementName').val(v[2].trim());
            $('#traceElementConcentration').val(v[3].trim());
            $('#traceElementUnit').val(v[4].trim());
            $('#traceElementUncertainty').val(v[5].trim());
            $('#traceElementBurnablePoison').val(v[6].trim());
            $('#traceElementComment').val(v[7].trim());
        }, '/trace-element/' + materialId + '/' + stage, function(){
            return {
                id: $('#traceElementId').val(),
                element: $('#traceElementName').val(),
                concentration: parseFloat($('#traceElementConcentration').val() || 0),
                unit: $('#traceElementUnit').val(),
                uncertainty: parseFloat($('#traceElementUncertainty').val() || 0),
                burnablePoison: $('#traceElementBurnablePoison').val(),
                notes: $('#traceElementComment').val()
            };
        });


        init('#elementDialog','#addElement','#saveElement','#elementTable', function(){
            return [$('#elementId').val(), $('#elementName').val(), $('#elementConcentration').val(), $('#elementUnit').val(), $('#elementUncertainty').val(), $('#elementBurnablePoison').val(), $('#elementComment').val()];
        }, function(v){
            $('#elementId').val(v[0].trim());
            $('#elementName').val(v[1].trim());
            $('#elementConcentration').val(v[2].trim());
            $('#elementUnit').val(v[3].trim());
            $('#elementUncertainty').val(v[4].trim());
            $('#elementBurnablePoison').val(v[5].trim());
            $('#elementComment').val(v[6].trim());
        }, '/element/' + materialId + '/' + stage, function(){
            return {
                id: $('#elementId').val(),
                element: $('#elementName').val(),
                concentration: parseFloat($('#elementConcentration').val() || 0),
                unit: $('#elementUnit').val(),
                uncertainty: parseFloat($('#elementUncertainty').val() || 0),
                burnablePoison: $('#elementBurnablePoison').val(),
                notes: $('#elementComment').val()
            };
        });

        init('#morphologyDialog','#addMorphology','#saveMorphology','#morphologyTable', function(){
            return [
                $('#morphId').val(),
                $('#morphStage').val(),
                $('#morphLatticeStructure').val(),
                $('#morphAspectRatio').val(),
                $('#morphPorosity').val(),
                $('#morphColour').val(),
                $('#morphParticle').val(),
                $('#morphShape').val(),
                $('#morphSurfaceFeatures').val(),
                $('#morphPlutonium').val(),
                $('#morphNotes').val()
            ];
        }, function(v){
            $('#morphId').val(v[0].trim());
            $('#morphStage').val(v[1].trim());
            $('#morphLatticeStructure').val(v[2].trim());
            $('#morphAspectRatio').val(v[3].trim());
            $('#morphPorosity').val(v[4].trim());
            $('#morphColour').val(v[5].trim());
            $('#morphParticle').val(v[6].trim());
            $('#morphShape').val(v[7].trim());
            $('#morphSurfaceFeatures').val(v[8].trim());
            $('#morphPlutonium').val(v[9].trim());
            $('#morphNotes').val(v[10].trim());
        }, '/morphology/' + materialId + '/' + stage, function(){
            return {
                id: $('#morphId').val(),
                latticeStructure: $('#morphLatticeStructure').val(),
                aspectRatio: $('#morphAspectRatio').val(),
                porosity: $('#morphPorosity').val(),
                colour: $('#morphColour').val(),
                particleSizeAndDistribution: $('#morphParticle').val(),
                shape: $('#morphShape').val(),
                surfaceFeatures: $('#morphSurfaceFeatures').val(),
                plutoniumHomogeneity: $('#morphPlutonium').val(),
                notes: $('#morphNotes').val()
            };
        });

        init('#uraniumDecayDialog','#addUraniumDecay','#saveUraniumDecay','#uraniumDecayTable', function(){
            return [
                $('#uraniumDecayId').val(),
                $('#uraniumDecayStage').val(),
                $('#uraniumDecayNuclide').val(),
                $('#uraniumDecayActivity').val(),
                $('#uraniumDecayUncertainty').val(),
                $('#uraniumDecayComment').val()
            ];
        }, function(v){
            $('#uraniumDecayId').val(v[0].trim());
            $('#uraniumDecayStage').val(v[1].trim());
            $('#uraniumDecayNuclide').val(v[2].trim());
            $('#uraniumDecayActivity').val(v[3].trim());
            $('#uraniumDecayUncertainty').val(v[4].trim());
            $('#uraniumDecayComment').val(v[5].trim());
        }, '/decay/' + materialId + '/' + stage, function(){
            return {
                id: $('#uraniumDecayId').val(),
                isotopeName: $('#uraniumDecayNuclide').val(),
                activityBq: parseFloat($('#uraniumDecayActivity').val() || 0),
                activityUncertaintyBq: parseFloat($('#uraniumDecayUncertainty').val() || 0),
                notes: $('#uraniumDecayComment').val()
            };
        });

        init('#containerDialog','#addContainer','#saveContainer','#containerTable', function(){
            return [$('#containerType').val(), $('#containerVolume').val(), $('#containerSerial').val(), $('#containerNotes').val()];
        }, function(v){
            $('#containerType').val(v[0].trim());
            $('#containerVolume').val(v[1].trim());
            $('#containerSerial').val(v[2].trim());
            $('#containerNotes').val(v[3].trim());
        }, '/container/' + materialId + '/' + stage, function(){
            return {
                type: $('#containerType').val(),
                volume: parseFloat($('#containerVolume').val() || 0),
                serialNumber: $('#containerSerial').val(),
                notes: $('#containerNotes').val()
            };
        });

        init('#generalInfoDialog','#addGeneralInfo','#saveGeneralInfo','#generalInfoTable', function(){
            return [
                $('#generalId').val(),
                $('#generalDataRecordDate').val(),
                $('#generalCustodian').val(),
                $('#generalLab').val(),
                $('#generalAnalysisDate').val(),
                $('#generalCountry').val(),
                $('#generalProducer').val(),
                $('#generalSupplier').val(),
                $('#generalBatchId').val(),
                $('#generalBatchProcessDate').val(),
                $('#generalShipperCarrier').val(),
                $('#generalReceiverInfo').val(),
                $('#generalShippingDate').val(),
                $('#generalReceivingDate').val(),
                $('#generalDataEvaluationInfo').val(),
                $('#generalVariationRangeNotes').val(),
                $('#generalInformationAcquisitionDate').val(),
                $('#generalUsedArchivedInformation').is(':checked'),
                $('#generalNotes').val()
            ];
        }, function(v){
            $('#generalId').val(v[0].trim());
            $('#generalDataRecordDate').val(v[2].trim());
            $('#generalCustodian').val(v[3].trim());
            $('#generalLab').val(v[4].trim());
            $('#generalAnalysisDate').val(v[5].trim());
            $('#generalCountry').val(v[6].trim());
            $('#generalProducer').val(v[7].trim());
            $('#generalSupplier').val(v[8].trim());
            $('#generalBatchId').val(v[9].trim());
            $('#generalBatchProcessDate').val(v[10].trim());
            $('#generalShipperCarrier').val(v[11].trim());
            $('#generalReceiverInfo').val(v[12].trim());
            $('#generalShippingDate').val(v[13].trim());
            $('#generalReceivingDate').val(v[14].trim());
            $('#generalDataEvaluationInfo').val(v[15].trim());
            $('#generalVariationRangeNotes').val(v[16].trim());
            $('#generalInformationAcquisitionDate').val(v[17].trim());
            $('#generalUsedArchivedInformation').prop('checked', v[18].trim().toLowerCase() === 'true');
            $('#generalNotes').val(v[19].trim());
        }, '/general-info/' + materialId + '/' + stage, function(){
            return {
                id: $('#generalId').val(),
                dataRecordDate: $('#generalDataRecordDate').val(),
                custodian: $('#generalCustodian').val(),
                analyticalLab: $('#generalLab').val(),
                analysisDate: $('#generalAnalysisDate').val(),
                countryOfOrigin: $('#generalCountry').val(),
                producer: $('#generalProducer').val(),
                supplier: $('#generalSupplier').val(),
                batchId: $('#generalBatchId').val(),
                batchProcessDate: $('#generalBatchProcessDate').val(),
                shipperCarrier: $('#generalShipperCarrier').val(),
                receiverInfo: $('#generalReceiverInfo').val(),
                shippingDate: $('#generalShippingDate').val(),
                receivingDate: $('#generalReceivingDate').val(),
                dataEvaluationInfo: $('#generalDataEvaluationInfo').val(),
                variationRangeNotes: $('#generalVariationRangeNotes').val(),
                informationAcquisitionDate: $('#generalInformationAcquisitionDate').val(),
                usedArchivedInformation: $('#generalUsedArchivedInformation').is(':checked'),
                notes: $('#generalNotes').val()
            };
        });

        init('#geologyDialog','#addGeology','#saveGeology','#geologyTable', function(){
            return [
                $('#geologyId').val(),
                $('#geologyStage').val(),
                $('#geologyLocation').val(),
                $('#geologyFormation').val(),
                $('#geologyDeposit').val(),
                $('#geologyTechnique').val(),
                $('#geologyColour').val(),
                $('#geologyNotes').val()
            ];
        }, function(v){
            $('#geologyId').val(v[0].trim());
            $('#geologyStage').val(v[1].trim());
            $('#geologyLocation').val(v[2].trim());
            $('#geologyFormation').val(v[3].trim());
            $('#geologyDeposit').val(v[4].trim());
            $('#geologyTechnique').val(v[5].trim());
            $('#geologyColour').val(v[6].trim());
            $('#geologyNotes').val(v[7].trim());
        }, '/geology/' + materialId + '/' + stage, function(){
            return {
                id: $('#geologyId').val(),
                mineLocation: $('#geologyLocation').val(),
                geologicalFormation: $('#geologyFormation').val(),
                depositTypes: $('#geologyDeposit').val(),
                miningTechnique: $('#geologyTechnique').val(),
                colour: $('#geologyColour').val(),
                notes: $('#geologyNotes').val()
            };
        });

        init('#irradiationDialog','#addIrradiation','#saveIrradiation','#irradiationTable', function(){
            return [$('#irradiationReactor').val(), $('#irradiationBurnUp').val(), $('#irradiationLoadDate').val(), $('#irradiationDischargeDate').val(), $('#irradiationNotes').val()];
        }, function(v){
            $('#irradiationReactor').val(v[0].trim());
            $('#irradiationBurnUp').val(v[1].trim());
            $('#irradiationLoadDate').val(v[2].trim());
            $('#irradiationDischargeDate').val(v[3].trim());
            $('#irradiationNotes').val(v[4].trim());
        }, '/irradiation/' + materialId + '/' + stage, function(){
            return {
                reactorType: $('#irradiationReactor').val(),
                burnUp: $('#irradiationBurnUp').val(),
                loadDate: $('#irradiationLoadDate').val(),
                dischargeDate: $('#irradiationDischargeDate').val(),
                notes: $('#irradiationNotes').val()
            };
        });

        init('#isotopeActivityDialog','#addIsotopeActivity','#saveIsotopeActivity','#isotopeActivityTable', function(){
            return [$('#isotopeActivityName').val(), $('#isotopeActivityValue').val(), $('#isotopeActivityDate').val(), $('#isotopeActivityNotes').val()];
        }, function(v){
            $('#isotopeActivityName').val(v[0].trim());
            $('#isotopeActivityValue').val(v[1].trim());
            $('#isotopeActivityDate').val(v[2].trim());
            $('#isotopeActivityNotes').val(v[3].trim());
        }, '/isotope-activity/' + materialId + '/' + stage, function(){
            return {
                isotopeName: $('#isotopeActivityName').val(),
                activityBq: parseFloat($('#isotopeActivityValue').val() || 0),
                referenceDate: $('#isotopeActivityDate').val(),
                notes: $('#isotopeActivityNotes').val()
            };
        });

        init('#mineralogyDialog','#addMineralogy','#saveMineralogy','#mineralogyTable', function(){
            return [
                $('#mineralogyId').val(),
                $('#mineralogyStage').val(),
                $('#mineralogyMinerals').val(),
                $('#mineralogyChemistry').val(),
                $('#mineralogyVolume').val(),
                $('#mineralogyNotes').val()];
        }, function(v){
            $('#mineralogyId').val(v[0].trim());
            $('#mineralogyStage').val(v[1].trim());
            $('#mineralogyMinerals').val(v[2].trim());
            $('#mineralogyChemistry').val(v[3].trim());
            $('#mineralogyVolume').val(v[4].trim());
            $('#mineralogyNotes').val(v[5].trim());
        }, '/mineralogy/' + materialId + '/' + stage, function(){
            return {
                id: $('#mineralogyId').val(),
                mineralsPresent: $('#mineralogyMinerals').val(),
                mineralChemistry: $('#mineralogyChemistry').val(),
                volumePercentages: parseFloat($('#mineralogyVolume').val() || 0),
                notes: $('#mineralogyNotes').val()
            };
        });

        init('#physicalDialog','#addPhysical','#savePhysical','#physicalTable', function(){
            return [
                $('#physicalId').val(),
                $('#physicalStage').val(),
                $('#physicalState').val(),
                $('#physicalDescription').val(),
                $('#physicalDensityValue').val(),
                $('#physicalDensityUnit').val(),
                $('#physicalMechanical').val(),
                $('#physicalDimension').val(),
                $('#physicalCladding').val(),
                $('#physicalCoating').val(),
                $('#physicalAssembly').val(),
                $('#physicalOxide').val(),
                $('#physicalMassValue').val(),
                $('#physicalMassUnit').val(),
                $('#physicalNotes').val()
            ];
        }, function(v){
            $('#physicalId').val(v[0].trim());
            $('#physicalStage').val(v[1].trim());
            $('#physicalState').val(v[2].trim());
            $('#physicalDescription').val(v[3].trim());
            $('#physicalDensityValue').val(v[4].trim());
            $('#physicalDensityUnit').val(v[5].trim());
            $('#physicalMechanical').val(v[6].trim());
            $('#physicalDimension').val(v[7].trim());
            $('#physicalCladding').val(v[8].trim());
            $('#physicalCoating').val(v[9].trim());
            $('#physicalAssembly').val(v[10].trim());
            $('#physicalOxide').val(v[11].trim());
            $('#physicalMassValue').val(v[12].trim());
            $('#physicalMassUnit').val(v[13].trim());
            $('#physicalNotes').val(v[14].trim());
        }, '/physical/' + materialId + '/' + stage, function(){
            var dimension = {};
            try { dimension = JSON.parse($('#physicalDimension').val() || '{}'); } catch(e) {}
            return {
                id: $('#physicalId').val(),
                densityValue: parseFloat($('#physicalDensityValue').val() || 0),
                densityUnit: $('#physicalDensityUnit').val(),
                stateOfMatter: $('#physicalState').val(),
                mechanicalProperties: $('#physicalMechanical').val(),
                description: $('#physicalDescription').val(),
                dimension: dimension,
                claddingInfo: $('#physicalCladding').val(),
                coatingInfo: $('#physicalCoating').val(),
                assemblyStructure: $('#physicalAssembly').val(),
                surfaceOxideThickness: $('#physicalOxide').val(),
                massValue: parseFloat($('#physicalMassValue').val() || 0),
                massUnit: parseFloat($('#physicalMassUnit').val() || 0),
                notes: $('#physicalNotes').val()
            };
        });

        init('#processInfoDialog','#addProcessInfo','#saveProcessInfo','#processInfoTable', function(){
            return [
                $('#processId').val(),
                $('#processStage').val(),
                $('#processType').val(),
                $('#processLocation').val(),
                $('#processStart').val(),
                $('#processEnd').val(),
                $('#processNotes').val()
            ];
        }, function(v){
            $('#processId').val(v[0].trim());
            $('#processStage').val(v[1].trim());
            $('#processType').val(v[2].trim());
            $('#processLocation').val(v[3].trim());
            $('#processStart').val(v[4].trim());
            $('#processEnd').val(v[5].trim());
            $('#processNotes').val(v[6].trim());
        }, '/process-info/' + materialId + '/' + stage, function(){
            return {
                id: $('#processId').val(),
                stage: $('#processStage').val(),
                processTypeOrDescription: $('#processType').val(),
                locationOfProcessingSite: $('#processLocation').val(),
                startDate: $('#processStart').val(),
                endDate: $('#processEnd').val(),
                notes: $('#processNotes').val()
            };
        });

        init('#serialNumberDialog','#addSerialNumber','#saveSerialNumber','#serialNumberTable', function(){
            return [$('#serialNumberValue').val(), $('#serialNumberNotes').val()];
        }, function(v){
            $('#serialNumberValue').val(v[0].trim());
            $('#serialNumberNotes').val(v[1].trim());
        }, '/serial-number/' + materialId + '/' + stage, function(){
            return {
                serialNumber: $('#serialNumberValue').val(),
                notes: $('#serialNumberNotes').val()
            };
        });

        init('#sourceActivityInfoDialog','#addSourceActivityInfo','#saveSourceActivityInfo','#sourceActivityInfoTable', function(){
            return [$('#sourceActivityValue').val(), $('#sourceActivityDate').val(), $('#sourceActivityNeutron').val(), $('#sourceActivityNotes').val()];
        }, function(v){
            $('#sourceActivityValue').val(v[0].trim());
            $('#sourceActivityDate').val(v[1].trim());
            $('#sourceActivityNeutron').val(v[2].trim());
            $('#sourceActivityNotes').val(v[3].trim());
        }, '/source-activity-info/' + materialId + '/' + stage, function(){
            return {
                activityBq: parseFloat($('#sourceActivityValue').val() || 0),
                referenceDate: $('#sourceActivityDate').val(),
                neutronIntensityPerSec: $('#sourceActivityNeutron').val(),
                notes: $('#sourceActivityNotes').val()
            };
        });

        init('#sourceDescriptionDialog','#addSourceDescription','#saveSourceDescription','#sourceDescriptionTable', function(){
            return [$('#sourceDescriptionType').val(), $('#sourceDescriptionQuantity').val(), $('#sourceDescriptionSerial').val(), $('#sourceDescriptionNotes').val()];
        }, function(v){
            $('#sourceDescriptionType').val(v[0].trim());
            $('#sourceDescriptionQuantity').val(v[1].trim());
            $('#sourceDescriptionSerial').val(v[2].trim());
            $('#sourceDescriptionNotes').val(v[3].trim());
        }, '/source-description/' + materialId + '/' + stage, function(){
            return {
                sourceType: $('#sourceDescriptionType').val(),
                quantity: $('#sourceDescriptionQuantity').val(),
                serialNumber: $('#sourceDescriptionSerial').val(),
                notes: $('#sourceDescriptionNotes').val()
            };
        });
    });
</script>
</body>
</html>
