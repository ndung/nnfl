<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout (~{::body},'index')}">
<body>
<div class="kt-container-fluid px=0">
    <div class="grid grid-cols-1 gap-5">

        <div th:replace="~{cards/general-info :: generalInfoCard}"></div>

        <th:block th:if="${stage == 0 or stage == 1}">
            <div th:replace="~{cards/geology :: geologyCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 9 or stage == 10}">
            <div th:replace="~{cards/source-description :: sourceDescriptionCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 9 or stage == 10}">
            <div th:replace="~{cards/source-activity-info :: sourceActivityInfoCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 2 or stage == 3 or stage == 4 or stage == 5 or stage == 6 or stage == 7 or stage == 9 or stage == 10}">
            <div th:replace="~{cards/chemical-form :: chemicalCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 1}">
            <div th:replace="~{cards/mineralogy :: mineralogyCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 2 or stage == 3 or stage == 4 or stage == 5 or stage == 6 or stage == 7 or stage == 8}">
            <div th:replace="~{cards/physical :: physicalCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 4 or stage == 5 or stage == 6 or stage == 8}">
            <div th:replace="~{cards/serial-number :: serialNumberCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 2 or stage == 3 or stage == 4}">
            <div th:replace="~{cards/morphology :: morphologyCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 4 or stage == 5 or stage == 6 or stage == 7 or stage == 8 or stage == 9 or stage == 10}">
            <div th:replace="~{cards/element :: elementCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 1 or stage == 2 or stage == 3}">
            <div th:replace="~{cards/uranium :: uraniumCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 1 or stage == 2 or stage == 3 or stage == 4 or stage == 5 or stage == 6 or stage == 7}">
            <div th:replace="~{cards/uranium-isotope :: uraniumIsotopeCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 2}">
            <div th:replace="~{cards/decay :: uraniumDecayCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 1 or stage == 2}">
            <div th:replace="~{cards/stable-isotope :: stableIsotopeCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 4 or stage == 5 or stage == 6 or stage == 7}">
            <div th:replace="~{cards/plutonium-isotope :: plutoniumIsotopeCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 1 or stage == 2 or stage == 3 or stage == 4 or stage == 5 or stage == 6 or stage == 7}">
            <div th:replace="~{cards/trace-element :: traceElementCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 8 or stage == 9 or stage == 10}">
            <div th:replace="~{cards/isotope-activity :: isotopeActivityCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 2 or stage == 3 or stage == 4 or stage == 5 or stage == 7}">
            <div th:replace="~{cards/process-info :: processInfoCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 3 or stage == 8}">
            <div th:replace="~{cards/container :: containerCard}"></div>
        </th:block>

        <th:block th:if="${stage == 0 or stage == 6}">
            <div th:replace="~{cards/irradiation :: irradiationCard}"></div>
        </th:block>

    </div>
</div>

<div th:replace="~{dialogs/chemical-form :: chemicalDialog}"></div>
<div th:replace="~{dialogs/uranium :: uraniumDialog}"></div>
<div th:replace="~{dialogs/uranium-isotope :: uraniumIsotopeDialog}"></div>
<div th:replace="~{dialogs/stable-isotope :: stableIsotopeDialog}"></div>
<div th:replace="~{dialogs/plutonium-isotope :: plutoniumIsotopeDialog}"></div>
<div th:replace="~{dialogs/trace-element :: traceElementDialog}"></div>
<div th:replace="~{dialogs/element :: elementDialog}"></div>
<div th:replace="~{dialogs/morphology :: morphologyDialog}"></div>
<div th:replace="~{dialogs/decay :: uraniumDecayDialog}"></div>
<div th:replace="~{dialogs/container :: containerDialog}"></div>
<div th:replace="~{dialogs/general-info :: generalInfoDialog}"></div>
<div th:replace="~{dialogs/geology :: geologyDialog}"></div>
<div th:replace="~{dialogs/irradiation :: irradiationDialog}"></div>
<div th:replace="~{dialogs/isotope-activity :: isotopeActivityDialog}"></div>
<div th:replace="~{dialogs/mineralogy :: mineralogyDialog}"></div>
<div th:replace="~{dialogs/physical :: physicalDialog}"></div>
<div th:replace="~{dialogs/process-info :: processInfoDialog}"></div>
<div th:replace="~{dialogs/serial-number :: serialNumberDialog}"></div>
<div th:replace="~{dialogs/source-activity-info :: sourceActivityInfoDialog}"></div>
<div th:replace="~{dialogs/source-description :: sourceDescriptionDialog}"></div>

<link rel="stylesheet" th:href="@{https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css}" />
<script th:src="@{https://code.jquery.com/jquery-3.7.1.min.js}"></script>
<script th:src="@{https://code.jquery.com/ui/1.13.2/jquery-ui.js}"></script>
<script>
    $(function(){
        var materialId = window.location.pathname.split('/')[2];
        var stage = window.location.pathname.split('/')[3];
        var csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        var csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

        function parseDecimalOrNull(value) {
            if (value === undefined || value === null) {
                return null;
            }
            var trimmed = ('' + value).trim();
            if (trimmed === '') {
                return null;
            }
            var parsed = parseFloat(trimmed);
            return isNaN(parsed) ? null : parsed;
        }

        function init(dialogId, addBtnId, saveBtnId, tableId, getData, setData, endpoint, getJsonData, options){
            options = options || {};
            var currentRow = null;
            $(dialogId).dialog({ autoOpen:false, modal:true, width:640 });
            $(addBtnId).click(function(){ currentRow=null; $(dialogId).dialog('open'); });
            $(tableId).on('click','.editRow', function(){
                currentRow = $(this).closest('tr');
                var values = currentRow.children('td').slice(0,-1).map(function(){ return $(this).text(); }).get();
                setData(values);
                $(dialogId).dialog('open');
            });
            $(saveBtnId).click(function(){
                var data = getData();
                var payload = getJsonData ? getJsonData() : data;
                var fileInput = options.fileInput ? document.querySelector(options.fileInput) : null;
                var hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
                var fetchOptions = {
                    method: 'POST',
                    credentials: 'same-origin'
                };
                var headers = {};
                if (hasFile) {
                    var formData = new FormData();
                    formData.append(options.payloadField || 'payload', JSON.stringify(payload));
                    formData.append(options.fileField || 'file', fileInput.files[0]);
                    if (csrfToken) {
                        headers[csrfHeader || 'X-CSRF-TOKEN'] = csrfToken;
                    }
                    if (Object.keys(headers).length > 0) {
                        fetchOptions.headers = headers;
                    }
                    fetchOptions.body = formData;
                } else {
                    headers['Content-Type'] = 'application/json';
                    if (csrfToken) {
                        headers[csrfHeader || 'X-CSRF-TOKEN'] = csrfToken;
                    }
                    fetchOptions.headers = headers;
                    fetchOptions.body = JSON.stringify(payload);
                }
                fetch(endpoint, fetchOptions)
                    .then(res => {
                        if (res.ok) {               // server sent 3xx (e.g., 303 See Other)
                            window.location.reload();
                        }
                        if (!res.ok) {
                            alert(res.status + ' ' + res.statusText);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Save failed: ' + err.message);
                    });
                $(dialogId).dialog('close');
                $(dialogId + ' input').val('');
            });
        }

        function createFileField(fileInputSelector, hiddenInputSelector, previewSelector, clearSelector) {
            var $fileInput = $(fileInputSelector);
            var $hiddenInput = $(hiddenInputSelector);
            var $previewLink = $(previewSelector);
            var $clearButton = clearSelector ? $(clearSelector) : null;
            var defaultText = $previewLink.text() || 'View file';

            function updateControls() {
                var fileElement = $fileInput.get(0);
                if (fileElement && fileElement.files && fileElement.files.length > 0) {
                    var name = fileElement.files[0].name;
                    $previewLink.removeAttr('href')
                        .text('Selected file: ' + name)
                        .show();
                    if ($clearButton) {
                        $clearButton.show();
                    }
                    return;
                }

                var value = $hiddenInput.val();
                if (value) {
                    $previewLink.attr('href', value)
                        .text(defaultText)
                        .show();
                    if ($clearButton) {
                        $clearButton.show();
                    }
                } else {
                    $previewLink.removeAttr('href')
                        .text(defaultText)
                        .hide();
                    if ($clearButton) {
                        $clearButton.hide();
                    }
                }
            }

            $previewLink.hide();

            if ($clearButton) {
                $clearButton.hide().on('click', function(){
                    $hiddenInput.val('');
                    $fileInput.val('');
                    updateControls();
                });
            }

            $fileInput.on('change', function(){
                updateControls();
            });

            updateControls();

            return {
                refresh: updateControls,
                clearInput: function(){ $fileInput.val(''); }
            };
        }

        init('#chemicalDialog','#addChemical','#saveChemical','#chemicalTable', function(){
            return [
                $('#chemicalId').val(),
                $('#chemicalStage').val() || stage,
                $('#chemicalName').val(),
                $('#chemicalDeviation').val(),
                $('#chemicalComment').val()];
        }, function(v){
            $('#chemicalId').val(v[0].trim());
            $('#chemicalStage').val(v[1].trim());
            $('#chemicalName').val(v[2].trim());
            $('#chemicalDeviation').val(v[3].trim());
            $('#chemicalComment').val(v[4].trim());
        }, '/chemical-form/' + materialId + '/' + stage, function(){
            return {
                id: $('#chemicalId').val(),
                stage: $('#chemicalStage').val() || stage,
                compoundName: $('#chemicalName').val(),
                stoichiometryDeviation: parseDecimalOrNull($('#chemicalDeviation').val()),
                notes: $('#chemicalComment').val()
            };
        });

        init('#uraniumDialog','#addUranium','#saveUranium','#uraniumTable', function(){
            return [
                $('#uraniumId').val(),
                $('#uraniumStage').val() || stage,
                $('#uraniumName').val(),
                $('#uraniumConcentration').val(),
                $('#uraniumUnit').val(),
                $('#uraniumUncertainty').val(),
                $('#uraniumBurnablePoison').val(),
                $('#uraniumComment').val()];
        }, function(v){
            $('#uraniumId').val(v[0].trim());
            $('#uraniumStage').val(v[1].trim());
            $('#uraniumName').val(v[2].trim());
            $('#uraniumConcentration').val(v[3].trim());
            $('#uraniumUnit').val(v[4].trim());
            $('#uraniumUncertainty').val(v[5].trim());
            $('#uraniumBurnablePoison').val(v[6].trim());
            $('#uraniumComment').val(v[7].trim());
        }, '/uranium/' + materialId + '/' + stage, function(){
            return {
                id: $('#uraniumId').val(),
                stage: $('#uraniumStage').val() || stage,
                element: $('#uraniumName').val(),
                concentration: parseDecimalOrNull($('#uraniumConcentration').val()),
                unit: $('#uraniumUnit').val(),
                uncertainty: parseDecimalOrNull($('#uraniumUncertainty').val()),
                burnablePoison: $('#uraniumBurnablePoison').val(),
                notes: $('#uraniumComment').val()
            };
        });

        init('#uraniumIsotopeDialog','#addUraniumIsotope','#saveUraniumIsotope','#uraniumIsotopeTable', function(){
            return [
                $('#uraniumIsotopeId').val(),
                $('#uraniumIsotopeStage').val() || stage,
                $('#uraniumIsotopeName').val(),
                $('#uraniumIsotopeRatio').val(),
                $('#uraniumIsotopeUncertainty').val(),
                $('#uraniumIsotopeUnit').val(),
                $('#uraniumIsotopeComment').val()];
        }, function(v){
            $('#uraniumIsotopeId').val(v[0].trim());
            $('#uraniumIsotopeStage').val(v[1].trim());
            $('#uraniumIsotopeName').val(v[2].trim());
            $('#uraniumIsotopeRatio').val(v[3].trim());
            $('#uraniumIsotopeUncertainty').val(v[4].trim());
            $('#uraniumIsotopeUnit').val(v[5].trim());
            $('#uraniumIsotopeComment').val(v[6].trim());
        }, '/uranium-isotope/' + materialId + '/' + stage, function(){
            return {
                id: $('#uraniumIsotopeId').val(),
                stage: $('#uraniumIsotopeStage').val() || stage,
                name: $('#uraniumIsotopeName').val(),
                value: parseDecimalOrNull($('#uraniumIsotopeRatio').val()),
                uncertainty: parseDecimalOrNull($('#uraniumIsotopeUncertainty').val()),
                unit: $('#uraniumIsotopeUnit').val(),
                notes: $('#uraniumIsotopeComment').val()
            };
        })

        init('#stableIsotopeDialog','#addStableIsotope','#saveStableIsotope','#stableIsotopeTable', function(){
            return [
                $('#stableIsotopeId').val(),
                $('#stableIsotopeStage').val() || stage,
                $('#stableIsotopeName').val(),
                $('#stableIsotopeRatio').val(),
                $('#stableIsotopeUncertainty').val(),
                $('#stableIsotopeUnit').val(),
                $('#stableIsotopeComment').val()];
        }, function(v){
            $('#stableIsotopeId').val(v[0].trim());
            $('#stableIsotopeStage').val(v[1].trim());
            $('#stableIsotopeName').val(v[2].trim());
            $('#stableIsotopeRatio').val(v[3].trim());
            $('#stableIsotopeUncertainty').val(v[4].trim());
            $('#stableIsotopeUnit').val(v[5].trim());
            $('#stableIsotopeComment').val(v[6].trim());
        }, '/stable-isotope/' + materialId + '/' + stage, function(){
            return {
                id: $('#stableIsotopeId').val(),
                stage: $('#stableIsotopeStage').val() || stage,
                name: $('#stableIsotopeName').val(),
                value: parseDecimalOrNull($('#stableIsotopeRatio').val()),
                uncertainty: parseDecimalOrNull($('#stableIsotopeUncertainty').val()),
                unit: $('#stableIsotopeUnit').val(),
                notes: $('#stableIsotopeComment').val()
            };
        });

        init('#plutoniumIsotopeDialog','#addPlutoniumIsotope','#savePlutoniumIsotope','#plutoniumIsotopeTable', function(){
            return [
                $('#plutoniumIsotopeId').val(),
                $('#plutoniumIsotopeStage').val() || stage,
                $('#plutoniumIsotopeName').val(),
                $('#plutoniumIsotopeRatio').val(),
                $('#plutoniumIsotopeUncertainty').val(),
                $('#plutoniumIsotopeUnit').val(),
                $('#plutoniumIsotopeComment').val()];
        }, function(v){
            $('#plutoniumIsotopeId').val(v[0].trim());
            $('#plutoniumIsotopeStage').val(v[1].trim());
            $('#plutoniumIsotopeName').val(v[2].trim());
            $('#plutoniumIsotopeRatio').val(v[3].trim());
            $('#plutoniumIsotopeUncertainty').val(v[4].trim());
            $('#plutoniumIsotopeUnit').val(v[5].trim());
            $('#plutoniumIsotopeComment').val(v[6].trim());
        }, '/plutonium-isotope/' + materialId + '/' + stage, function(){
            return {
                id: $('#plutoniumIsotopeId').val(),
                stage: $('#plutoniumIsotopeStage').val() || stage,
                name: $('#plutoniumIsotopeName').val(),
                value: parseDecimalOrNull($('#plutoniumIsotopeRatio').val()),
                uncertainty: parseDecimalOrNull($('#plutoniumIsotopeUncertainty').val()),
                unit: $('#plutoniumIsotopeUnit').val(),
                notes: $('#plutoniumIsotopeComment').val()
            };
        });

        init('#traceElementDialog','#addTraceElement','#saveTraceElement','#traceElementTable', function(){
            return [
                $('#traceElementId').val(),
                $('#traceElementStage').val() || stage,
                $('#traceElementName').val(),
                $('#traceElementConcentration').val(),
                $('#traceElementUnit').val(),
                $('#traceElementUncertainty').val(),
                $('#traceElementComment').val()];
        }, function(v){
            $('#traceElementId').val(v[0].trim());
            $('#traceElementStage').val(v[1].trim());
            $('#traceElementName').val(v[2].trim());
            $('#traceElementConcentration').val(v[3].trim());
            $('#traceElementUnit').val(v[4].trim());
            $('#traceElementUncertainty').val(v[5].trim());
            $('#traceElementComment').val(v[6].trim());
        }, '/trace-element/' + materialId + '/' + stage, function(){
            return {
                id: $('#traceElementId').val(),
                stage: $('#traceElementStage').val() || stage,
                element: $('#traceElementName').val(),
                concentration: parseDecimalOrNull($('#traceElementConcentration').val()),
                unit: $('#traceElementUnit').val(),
                uncertainty: parseDecimalOrNull($('#traceElementUncertainty').val()),
                notes: $('#traceElementComment').val()
            };
        });


        init('#elementDialog','#addElement','#saveElement','#elementTable', function(){
            return [
                $('#elementId').val(),
                $('#elementStage').val() || stage,
                $('#elementName').val(),
                $('#elementConcentration').val(),
                $('#elementUnit').val(),
                $('#elementUncertainty').val(),
                $('#elementBurnablePoison').val(),
                $('#elementComment').val()];
        }, function(v){
            $('#elementId').val(v[0].trim());
            $('#elementStage').val(v[1].trim());
            $('#elementName').val(v[2].trim());
            $('#elementConcentration').val(v[3].trim());
            $('#elementUnit').val(v[4].trim());
            $('#elementUncertainty').val(v[5].trim());
            $('#elementBurnablePoison').val(v[6].trim());
            $('#elementComment').val(v[7].trim());
        }, '/element/' + materialId + '/' + stage, function(){
            return {
                id: $('#elementId').val(),
                stage: $('#elementStage').val() || stage,
                element: $('#elementName').val(),
                concentration: parseDecimalOrNull($('#elementConcentration').val()),
                unit: $('#elementUnit').val(),
                uncertainty: parseDecimalOrNull($('#elementUncertainty').val()),
                burnablePoison: $('#elementBurnablePoison').val(),
                notes: $('#elementComment').val()
            };
        });

        var morphologyFileField = createFileField('#morphImageFileInput', '#morphImageFile', '#morphImageFilePreview', '#morphImageFileClear');
        $('#morphologyDialog').on('dialogopen', function(){
            if (!$('#morphId').val()) {
                $('#morphImageFile').val('');
            }
            morphologyFileField.clearInput();
            morphologyFileField.refresh();
        }).on('dialogclose', function(){
            morphologyFileField.clearInput();
            morphologyFileField.refresh();
        });

        init('#morphologyDialog','#addMorphology','#saveMorphology','#morphologyTable', function(){
            return [
                $('#morphId').val(),
                $('#morphStage').val() || stage,
                $('#morphLatticeStructure').val(),
                $('#morphAspectRatio').val(),
                $('#morphPorosity').val(),
                $('#morphColour').val(),
                $('#morphParticle').val(),
                $('#morphShape').val(),
                $('#morphSurfaceFeatures').val(),
                $('#morphPlutonium').val(),
                $('#morphNotes').val(),
                $('#morphImageFile').val(),
                $('#morphMagnification').val()
            ];
        }, function(v){
            $('#morphId').val(v[0].trim());
            $('#morphStage').val(v[1].trim());
            $('#morphLatticeStructure').val(v[2].trim());
            $('#morphAspectRatio').val(v[3].trim());
            $('#morphPorosity').val(v[4].trim());
            $('#morphColour').val(v[5].trim());
            $('#morphParticle').val(v[6].trim());
            $('#morphShape').val(v[7].trim());
            $('#morphSurfaceFeatures').val(v[8].trim());
            $('#morphPlutonium').val(v[9].trim());
            $('#morphNotes').val(v[10].trim());
            $('#morphImageFile').val((v[11] || '').trim());
            $('#morphMagnification').val(v[12].trim());
            morphologyFileField.clearInput();
            morphologyFileField.refresh();
        }, '/morphology/' + materialId + '/' + stage, function(){
            return {
                id: $('#morphId').val(),
                stage: $('#morphStage').val() || stage,
                latticeStructure: $('#morphLatticeStructure').val(),
                aspectRatio: $('#morphAspectRatio').val(),
                porosity: $('#morphPorosity').val(),
                colour: $('#morphColour').val(),
                particleSizeAndDistribution: $('#morphParticle').val(),
                shape: $('#morphShape').val(),
                surfaceFeatures: $('#morphSurfaceFeatures').val(),
                plutoniumHomogeneity: $('#morphPlutonium').val(),
                notes: $('#morphNotes').val(),
                imageFile: $('#morphImageFile').val(),
                magnification: parseDecimalOrNull($('#morphMagnification').val())
            };
        }, { fileInput: '#morphImageFileInput' });

        init('#uraniumDecayDialog','#addUraniumDecay','#saveUraniumDecay','#uraniumDecayTable', function(){
            return [
                $('#uraniumDecayId').val(),
                $('#uraniumDecayStage').val() || stage,
                $('#uraniumDecayNuclide').val(),
                $('#uraniumDecayActivity').val(),
                $('#uraniumDecayUncertainty').val(),
                $('#uraniumDecayComment').val()
            ];
        }, function(v){
            $('#uraniumDecayId').val(v[0].trim());
            $('#uraniumDecayStage').val(v[1].trim());
            $('#uraniumDecayNuclide').val(v[2].trim());
            $('#uraniumDecayActivity').val(v[3].trim());
            $('#uraniumDecayUncertainty').val(v[4].trim());
            $('#uraniumDecayComment').val(v[5].trim());
        }, '/decay/' + materialId + '/' + stage, function(){
            return {
                id: $('#uraniumDecayId').val(),
                stage: $('#uraniumDecayStage').val() || stage,
                isotopeName: $('#uraniumDecayNuclide').val(),
                activityBq: parseDecimalOrNull($('#uraniumDecayActivity').val()),
                activityUncertaintyBq: parseDecimalOrNull($('#uraniumDecayUncertainty').val()),
                notes: $('#uraniumDecayComment').val()
            };
        });

        init('#containerDialog','#addContainer','#saveContainer','#containerTable', function(){
            return [
                $('#containerId').val(),
                $('#containerStage').val() || stage,
                $('#containerType').val(),
                $('#containerVolume').val(),
                $('#containerUnit').val(),
                $('#containerDimensions').val(),
                $('#containerNotes').val()
            ];
        }, function(v){
            $('#containerId').val(v[0].trim());
            $('#containerStage').val(v[1].trim());
            $('#containerType').val(v[2].trim());
            $('#containerVolume').val(v[3].trim());
            $('#containerUnit').val(v[4].trim());
            $('#containerDimensions').val(v[5].trim());
            $('#containerNotes').val(v[6].trim());
        }, '/container/' + materialId + '/' + stage, function(){
            return {
                id: $('#containerId').val(),
                stage: $('#containerStage').val() || stage,
                type: $('#containerType').val(),
                volumeValue: parseDecimalOrNull($('#containerVolume').val()),
                volumeUnit: $('#containerUnit').val(),
                dimensions: $('#containerDimensions').val(),
                notes: $('#containerNotes').val()
            };
        });

        $('#addContainer').click(function(){ $('#containerStage').val(stage); });

        var generalInfoFileField = createFileField('#generalImageFileInput', '#generalImageFile', '#generalImageFilePreview', '#generalImageFileClear');
        $('#generalInfoDialog').on('dialogopen', function(){
            if (!$('#generalId').val()) {
                $('#generalImageFile').val('');
            }
            generalInfoFileField.clearInput();
            generalInfoFileField.refresh();
        }).on('dialogclose', function(){
            generalInfoFileField.clearInput();
            generalInfoFileField.refresh();
        });

        init('#generalInfoDialog','#addGeneralInfo','#saveGeneralInfo','#generalInfoTable', function(){
            return [
                $('#generalId').val(),
                $('#generalStage').val() || stage,
                $('#generalDataRecordDate').val(),
                $('#generalCustodian').val(),
                $('#generalLab').val(),
                $('#generalAnalysisDate').val(),
                $('#generalCountry').val(),
                $('#generalProducer').val(),
                $('#generalSupplier').val(),
                $('#generalBatchId').val(),
                $('#generalBatchProcessDate').val(),
                $('#generalShipperCarrier').val(),
                $('#generalReceiverInfo').val(),
                $('#generalShippingDate').val(),
                $('#generalReceivingDate').val(),
                $('#generalDataEvaluationInfo').val(),
                $('#generalVariationRangeNotes').val(),
                $('#generalInformationAcquisitionDate').val(),
                $('#generalUsedArchivedInformation').is(':checked'),
                $('#generalNotes').val(),
                $('#generalImageFile').val()
            ];
        }, function(v){
            $('#generalId').val(v[0].trim());
            $('#generalStage').val(v[1].trim());
            $('#generalDataRecordDate').val(v[2].trim());
            $('#generalCustodian').val(v[3].trim());
            $('#generalLab').val(v[4].trim());
            $('#generalAnalysisDate').val(v[5].trim());
            $('#generalCountry').val(v[6].trim());
            $('#generalProducer').val(v[7].trim());
            $('#generalSupplier').val(v[8].trim());
            $('#generalBatchId').val(v[9].trim());
            $('#generalBatchProcessDate').val(v[10].trim());
            $('#generalShipperCarrier').val(v[11].trim());
            $('#generalReceiverInfo').val(v[12].trim());
            $('#generalShippingDate').val(v[13].trim());
            $('#generalReceivingDate').val(v[14].trim());
            $('#generalDataEvaluationInfo').val(v[15].trim());
            $('#generalVariationRangeNotes').val(v[16].trim());
            $('#generalInformationAcquisitionDate').val(v[17].trim());
            $('#generalUsedArchivedInformation').prop('checked', (v[18] || '').trim().toLowerCase() === 'true');
            $('#generalNotes').val(v[19].trim());
            $('#generalImageFile').val((v[20] || '').trim());
            generalInfoFileField.clearInput();
            generalInfoFileField.refresh();
        }, '/general-info/' + materialId + '/' + stage, function(){
            return {
                id: $('#generalId').val(),
                stage: $('#generalStage').val() || stage,
                dataRecordDate: $('#generalDataRecordDate').val(),
                custodian: $('#generalCustodian').val(),
                analyticalLab: $('#generalLab').val(),
                analysisDate: $('#generalAnalysisDate').val(),
                countryOfOrigin: $('#generalCountry').val(),
                producer: $('#generalProducer').val(),
                supplier: $('#generalSupplier').val(),
                batchId: $('#generalBatchId').val(),
                batchProcessDate: $('#generalBatchProcessDate').val(),
                shipperCarrier: $('#generalShipperCarrier').val(),
                receiverInfo: $('#generalReceiverInfo').val(),
                shippingDate: $('#generalShippingDate').val(),
                receivingDate: $('#generalReceivingDate').val(),
                dataEvaluationInfo: $('#generalDataEvaluationInfo').val(),
                variationRangeNotes: $('#generalVariationRangeNotes').val(),
                informationAcquisitionDate: $('#generalInformationAcquisitionDate').val(),
                usedArchivedInformation: $('#generalUsedArchivedInformation').is(':checked'),
                notes: $('#generalNotes').val(),
                imageFile: $('#generalImageFile').val()
            };
        }, { fileInput: '#generalImageFileInput' });

        init('#geologyDialog','#addGeology','#saveGeology','#geologyTable', function(){
            return [
                $('#geologyId').val(),
                $('#geologyStage').val() || stage,
                $('#geologyLocation').val(),
                $('#geologyFormation').val(),
                $('#geologyDeposit').val(),
                $('#geologyTechnique').val(),
                $('#geologyColour').val(),
                $('#geologyNotes').val()
            ];
        }, function(v){
            $('#geologyId').val(v[0].trim());
            $('#geologyStage').val(v[1].trim());
            $('#geologyLocation').val(v[2].trim());
            $('#geologyFormation').val(v[3].trim());
            $('#geologyDeposit').val(v[4].trim());
            $('#geologyTechnique').val(v[5].trim());
            $('#geologyColour').val(v[6].trim());
            $('#geologyNotes').val(v[7].trim());
        }, '/geology/' + materialId + '/' + stage, function(){
            return {
                id: $('#geologyId').val(),
                stage: $('#geologyStage').val() || stage,
                mineLocation: $('#geologyLocation').val(),
                geologicalFormation: $('#geologyFormation').val(),
                depositTypes: $('#geologyDeposit').val(),
                miningTechnique: $('#geologyTechnique').val(),
                colour: $('#geologyColour').val(),
                notes: $('#geologyNotes').val()
            };
        });

        init('#irradiationDialog','#addIrradiation','#saveIrradiation','#irradiationTable', function(){
            return [
                $('#irradiationId').val(),
                $('#irradiationStage').val() || stage,
                $('#irradiationReactor').val(),
                $('#irradiationBurnUp').val(),
                $('#irradiationAssemblyPowerHistory').val(),
                $('#irradiationOperatingRecordsRef').val(),
                $('#irradiationLoadDate').val(),
                $('#irradiationDischargeDate').val(),
                $('#irradiationRadiationLevel').val(),
                $('#irradiationNotes').val()];
        }, function(v){
            $('#irradiationId').val(v[0].trim());
            $('#irradiationStage').val(v[1].trim());
            $('#irradiationReactor').val(v[2].trim());
            $('#irradiationBurnUp').val(v[3].trim());
            $('#irradiationAssemblyPowerHistory').val(v[4].trim());
            $('#irradiationOperatingRecordsRef').val(v[5].trim());
            $('#irradiationLoadDate').val(v[6].trim());
            $('#irradiationDischargeDate').val(v[7].trim());
            $('#irradiationRadiationLevel').val(v[8].trim());
            $('#irradiationNotes').val(v[9].trim());
        }, '/irradiation/' + materialId + '/' + stage, function(){
            return {
                id: $('#irradiationId').val(),
                stage: $('#irradiationStage').val() || stage,
                reactorType: $('#irradiationReactor').val(),
                burnUp: $('#irradiationBurnUp').val(),
                assemblyPowerHistory: $('#irradiationAssemblyPowerHistory').val(),
                operatingRecordsRef: $('#irradiationOperatingRecordsRef').val(),
                loadDate: $('#irradiationLoadDate').val(),
                dischargeDate: $('#irradiationDischargeDate').val(),
                radiationLevel: $('#irradiationRadiationLevel').val(),
                notes: $('#irradiationNotes').val()
            };
        });

        init('#isotopeActivityDialog','#addIsotopeActivity','#saveIsotopeActivity','#isotopeActivityTable', function(){
            return [
                $('#isotopeActivityId').val(),
                $('#isotopeActivityStage').val() || stage,
                $('#isotopeActivityName').val(),
                $('#isotopeActivityValue').val(),
                $('#isotopeActivityUncertainty').val(),
                $('#isotopeActivityDate').val(),
                $('#isotopeActivityMajor').is(':checked'),
                $('#isotopeActivityNotes').val()
            ];
        }, function(v){
            $('#isotopeActivityId').val(v[0].trim());
            $('#isotopeActivityStage').val(v[1].trim());
            $('#isotopeActivityName').val(v[2].trim());
            $('#isotopeActivityValue').val(v[3].trim());
            $('#isotopeActivityUncertainty').val(v[4].trim());
            $('#isotopeActivityDate').val(v[5].trim());
            $('#isotopeActivityMajor').prop('checked', v[6].trim().toLowerCase() === 'true');
            $('#isotopeActivityNotes').val(v[7].trim());
        }, '/isotope-activity/' + materialId + '/' + stage, function(){
            return {
                id: $('#isotopeActivityId').val(),
                stage: $('#isotopeActivityStage').val() || stage,
                isotopeName: $('#isotopeActivityName').val(),
                activityBq: parseDecimalOrNull($('#isotopeActivityValue').val()),
                activityUncertaintyBq: parseDecimalOrNull($('#isotopeActivityUncertainty').val()),
                referenceDate: $('#isotopeActivityDate').val(),
                major: $('#isotopeActivityMajor').is(':checked'),
                notes: $('#isotopeActivityNotes').val()
            };
        });

        init('#mineralogyDialog','#addMineralogy','#saveMineralogy','#mineralogyTable', function(){
            return [
                $('#mineralogyId').val(),
                $('#mineralogyStage').val() || stage,
                $('#mineralogyMinerals').val(),
                $('#mineralogyChemistry').val(),
                $('#mineralogyVolume').val(),
                $('#mineralogyNotes').val()];
        }, function(v){
            $('#mineralogyId').val(v[0].trim());
            $('#mineralogyStage').val(v[1].trim());
            $('#mineralogyMinerals').val(v[2].trim());
            $('#mineralogyChemistry').val(v[3].trim());
            $('#mineralogyVolume').val(v[4].trim());
            $('#mineralogyNotes').val(v[5].trim());
        }, '/mineralogy/' + materialId + '/' + stage, function(){
            return {
                id: $('#mineralogyId').val(),
                stage: $('#mineralogyStage').val() || stage,
                mineralsPresent: $('#mineralogyMinerals').val(),
                mineralChemistry: $('#mineralogyChemistry').val(),
                volumePercentages: parseDecimalOrNull($('#mineralogyVolume').val()),
                notes: $('#mineralogyNotes').val()
            };
        });

        init('#physicalDialog','#addPhysical','#savePhysical','#physicalTable', function(){
            return [
                $('#physicalId').val(),
                $('#physicalStage').val() || stage,
                $('#physicalState').val(),
                $('#physicalDescription').val(),
                $('#physicalDensityValue').val(),
                $('#physicalDensityUnit').val(),
                $('#physicalMechanical').val(),
                $('#physicalDimensions').val(),
                $('#physicalCladding').val(),
                $('#physicalCoating').val(),
                $('#physicalAssembly').val(),
                $('#physicalOxide').val(),
                $('#physicalMassValue').val(),
                $('#physicalMassUnit').val(),
                $('#physicalSerialNumbers').val(),
                $('#physicalNotes').val()
            ];
        }, function(v){
            $('#physicalId').val(v[0].trim());
            $('#physicalStage').val(v[1].trim());
            $('#physicalState').val(v[2].trim());
            $('#physicalDescription').val(v[3].trim());
            $('#physicalDensityValue').val(v[4].trim());
            $('#physicalDensityUnit').val(v[5].trim());
            $('#physicalMechanical').val(v[6].trim());
            $('#physicalDimensions').val(v[7].trim());
            $('#physicalCladding').val(v[8].trim());
            $('#physicalCoating').val(v[9].trim());
            $('#physicalAssembly').val(v[10].trim());
            $('#physicalOxide').val(v[11].trim());
            $('#physicalMassValue').val(v[12].trim());
            $('#physicalMassUnit').val(v[13].trim());
            $('#physicalSerialNumbers').val(v[14].trim());
            $('#physicalNotes').val(v[15].trim());
        }, '/physical/' + materialId + '/' + stage, function(){
            return {
                id: $('#physicalId').val(),
                stage: $('#physicalStage').val() || stage,
                densityValue: parseDecimalOrNull($('#physicalDensityValue').val()),
                densityUnit: $('#physicalDensityUnit').val(),
                stateOfMatter: $('#physicalState').val(),
                mechanicalProperties: $('#physicalMechanical').val(),
                description: $('#physicalDescription').val(),
                dimensions: $('#physicalDimensions').val(),
                claddingInfo: $('#physicalCladding').val(),
                coatingInfo: $('#physicalCoating').val(),
                assemblyStructure: $('#physicalAssembly').val(),
                surfaceOxideThickness: $('#physicalOxide').val(),
                massValue: parseDecimalOrNull($('#physicalMassValue').val()),
                massUnit: $('#physicalMassUnit').val(),
                serialNumbers: $('#physicalSerialNumbers').val(),
                notes: $('#physicalNotes').val()
            };
        });

        init('#processInfoDialog','#addProcessInfo','#saveProcessInfo','#processInfoTable', function(){
            return [
                $('#processId').val(),
                $('#processStage').val() || stage,
                $('#processType').val(),
                $('#processLocation').val(),
                $('#processStart').val(),
                $('#processEnd').val(),
                $('#processNotes').val()
            ];
        }, function(v){
            $('#processId').val(v[0].trim());
            $('#processStage').val(v[1].trim());
            $('#processType').val(v[2].trim());
            $('#processLocation').val(v[3].trim());
            $('#processStart').val(v[4].trim());
            $('#processEnd').val(v[5].trim());
            $('#processNotes').val(v[6].trim());
        }, '/process-info/' + materialId + '/' + stage, function(){
            return {
                id: $('#processId').val(),
                stage: $('#processStage').val() || stage,
                processTypeOrDescription: $('#processType').val(),
                locationOfProcessingSite: $('#processLocation').val(),
                startDate: $('#processStart').val(),
                endDate: $('#processEnd').val(),
                notes: $('#processNotes').val()
            };
        });

        init('#serialNumberDialog','#addSerialNumber','#saveSerialNumber','#serialNumberTable', function(){
            return [
                $('#serialNumberId').val(),
                $('#serialNumberStage').val() || stage,
                $('#serialNumberValue').val(),
                $('#serialNumberNotes').val()
            ];
        }, function(v){
            $('#serialNumberId').val(v[0].trim());
            $('#serialNumberStage').val(v[1].trim());
            $('#serialNumberValue').val(v[2].trim());
            $('#serialNumberNotes').val(v[3].trim());
        }, '/serial-number/' + materialId + '/' + stage, function(){
            return {
                id: $('#serialNumberId').val(),
                stage: $('#serialNumberStage').val() || stage,
                serialNumber: $('#serialNumberValue').val(),
                notes: $('#serialNumberNotes').val()
            };
        });

        $('#addSerialNumber').click(function(){ $('#serialNumberStage').val(stage); });

        init('#sourceActivityInfoDialog','#addSourceActivityInfo','#saveSourceActivityInfo','#sourceActivityInfoTable', function(){
            return [
                $('#sourceActivityId').val(),
                $('#sourceActivityStage').val() || stage,
                $('#sourceActivityValue').val(),
                $('#sourceActivityDate').val(),
                $('#sourceActivityNeutron').val(),
                $('#sourceActivityNotes').val()
            ];
        }, function(v){
            $('#sourceActivityId').val(v[0].trim());
            $('#sourceActivityStage').val(v[1].trim());
            $('#sourceActivityValue').val(v[2].trim());
            $('#sourceActivityDate').val(v[3].trim());
            $('#sourceActivityNeutron').val(v[4].trim());
            $('#sourceActivityNotes').val(v[5].trim());
        }, '/source-activity-info/' + materialId + '/' + stage, function(){
            return {
                id: $('#sourceActivityId').val(),
                stage: $('#sourceActivityStage').val() || stage,
                activityBq: parseDecimalOrNull($('#sourceActivityValue').val()),
                referenceDate: $('#sourceActivityDate').val(),
                neutronIntensityPerSec: parseDecimalOrNull($('#sourceActivityNeutron').val()),
                notes: $('#sourceActivityNotes').val()
            };
        });

        var sourceDescriptionFileField = createFileField('#sourceDescriptionImageFileInput', '#sourceDescriptionImageFile', '#sourceDescriptionImageFilePreview', '#sourceDescriptionImageFileClear');
        $('#sourceDescriptionDialog').on('dialogopen', function(){
            if (!$('#sourceDescriptionId').val()) {
                $('#sourceDescriptionImageFile').val('');
            }
            sourceDescriptionFileField.clearInput();
            sourceDescriptionFileField.refresh();
        }).on('dialogclose', function(){
            sourceDescriptionFileField.clearInput();
            sourceDescriptionFileField.refresh();
        });

        init('#sourceDescriptionDialog','#addSourceDescription','#saveSourceDescription','#sourceDescriptionTable', function(){
            return [
                $('#sourceDescriptionId').val(),
                $('#sourceDescriptionStage').val() || stage,
                $('#sourceDescriptionType').val(),
                $('#sourceDescriptionQuantity').val(),
                $('#sourceDescriptionDescription').val(),
                $('#sourceDescriptionDimensions').val(),
                $('#sourceDescriptionEncapsulation').val(),
                $('#sourceDescriptionSerial').val(),
                $('#sourceDescriptionShipping').val(),
                $('#sourceDescriptionReceiving').val(),
                $('#sourceDescriptionRadiograph').val(),
                $('#sourceDescriptionImageFile').val(),
                $('#sourceDescriptionNotes').val()
            ];
        }, function(v){
            $('#sourceDescriptionId').val(v[0].trim());
            $('#sourceDescriptionStage').val(v[1].trim());
            $('#sourceDescriptionType').val(v[2].trim());
            $('#sourceDescriptionQuantity').val(v[3].trim());
            $('#sourceDescriptionDescription').val(v[4].trim());
            $('#sourceDescriptionDimensions').val(v[5].trim());
            $('#sourceDescriptionEncapsulation').val(v[6].trim());
            $('#sourceDescriptionSerial').val(v[7].trim());
            $('#sourceDescriptionShipping').val(v[8].trim());
            $('#sourceDescriptionReceiving').val(v[9].trim());
            $('#sourceDescriptionRadiograph').val(v[10].trim());
            $('#sourceDescriptionImageFile').val((v[11] || '').trim());
            $('#sourceDescriptionNotes').val(v[12].trim());
            sourceDescriptionFileField.clearInput();
            sourceDescriptionFileField.refresh();
        }, '/source-description/' + materialId + '/' + stage, function(){
            return {
                id: $('#sourceDescriptionId').val(),
                stage: $('#sourceDescriptionStage').val() || stage,
                sourceType: $('#sourceDescriptionType').val(),
                quantity: $('#sourceDescriptionQuantity').val(),
                description: $('#sourceDescriptionDescription').val(),
                dimensions: $('#sourceDescriptionDimensions').val(),
                encapsulationOrCladding: $('#sourceDescriptionEncapsulation').val(),
                serialNumber: $('#sourceDescriptionSerial').val(),
                shippingHistory: $('#sourceDescriptionShipping').val(),
                receivingHistory: $('#sourceDescriptionReceiving').val(),
                radiographOrPhotograph: $('#sourceDescriptionRadiograph').val(),
                imageFile: $('#sourceDescriptionImageFile').val(),
                notes: $('#sourceDescriptionNotes').val()
            };
        }, { fileInput: '#sourceDescriptionImageFileInput' });
    });
</script>
</body>
</html>
