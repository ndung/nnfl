<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout (~{::body},'index')}">
<body>
<div class="kt-container-fluid px=0">
    <div class="grid grid-cols-1 gap-5">

        <div th:replace="~{cards/general-info :: generalInfoCard}"></div>

        <th:block th:if="${stage == 1}">
            <div th:replace="~{cards/geology :: geologyCard}"></div>
        </th:block>

        <th:block th:if="${stage == 1}">
            <div th:replace="~{cards/mineralogy :: mineralogyCard}"></div>
        </th:block>

        <th:block th:if="${stage == 2 or stage == 3}">
            <div th:replace="~{cards/chemical-form :: chemicalCard}"></div>
        </th:block>

        <div th:replace="~{cards/element :: elementCard}"></div>
        <div th:replace="~{cards/isotope :: isotopeCard}"></div>
        <div th:replace="~{cards/morphology :: morphologyCard}"></div>
        <div th:replace="~{cards/decay :: decayCard}"></div>
        <div th:replace="~{cards/container :: containerCard}"></div>
        <div th:replace="~{cards/irradiation :: irradiationCard}"></div>
        <div th:replace="~{cards/isotope-activity :: isotopeActivityCard}"></div>
        <div th:replace="~{cards/physical :: physicalCard}"></div>
        <div th:replace="~{cards/process-info :: processInfoCard}"></div>
        <div th:replace="~{cards/serial-number :: serialNumberCard}"></div>
        <div th:replace="~{cards/source-activity-info :: sourceActivityInfoCard}"></div>
        <div th:replace="~{cards/source-description :: sourceDescriptionCard}"></div>

    </div>
</div>

<div th:replace="~{dialogs/chemical-form :: chemicalDialog}"></div>
<div th:replace="~{dialogs/element :: elementDialog}"></div>
<div th:replace="~{dialogs/isotope :: isotopeDialog}"></div>
<div th:replace="~{dialogs/morphology :: morphologyDialog}"></div>
<div th:replace="~{dialogs/decay :: decayDialog}"></div>
<div th:replace="~{dialogs/container :: containerDialog}"></div>
<div th:replace="~{dialogs/general-info :: generalInfoDialog}"></div>
<div th:replace="~{dialogs/geology :: geologyDialog}"></div>
<div th:replace="~{dialogs/irradiation :: irradiationDialog}"></div>
<div th:replace="~{dialogs/isotope-activity :: isotopeActivityDialog}"></div>
<div th:replace="~{dialogs/mineralogy :: mineralogyDialog}"></div>
<div th:replace="~{dialogs/physical :: physicalDialog}"></div>
<div th:replace="~{dialogs/process-info :: processInfoDialog}"></div>
<div th:replace="~{dialogs/serial-number :: serialNumberDialog}"></div>
<div th:replace="~{dialogs/source-activity-info :: sourceActivityInfoDialog}"></div>
<div th:replace="~{dialogs/source-description :: sourceDescriptionDialog}"></div>


<link rel="stylesheet" th:href="@{https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css}" />
<script th:src="@{https://code.jquery.com/jquery-3.7.1.min.js}"></script>
<script th:src="@{https://code.jquery.com/ui/1.13.2/jquery-ui.js}"></script>
<script>
    $(function(){
        var materialId = window.location.pathname.split('/')[3];
        var stage = window.location.pathname.split('/')[4];
        var csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        var csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

        function init(dialogId, addBtnId, saveBtnId, tableId, getData, setData, endpoint, getJsonData){
            var currentRow = null;
            $(dialogId).dialog({ autoOpen:false, modal:true, width:640 });
            $(addBtnId).click(function(){ currentRow=null; $(dialogId).dialog('open'); });
            $(tableId).on('click','.editRow', function(){
                currentRow = $(this).closest('tr');
                var values = currentRow.children('td').slice(0,-1).map(function(){ return $(this).text(); }).get();
                setData(values);
                $(dialogId).dialog('open');
            });
            $(saveBtnId).click(function(){
                var data = getData();
                var payload = getJsonData ? getJsonData() : data;
                var headers = {'Content-Type':'application/json'};
                if (csrfToken) {
                    headers[csrfHeader || 'X-CSRF-TOKEN'] = csrfToken;
                }
                fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload),
                    credentials: 'same-origin'
                })
                    .then(res => {
                        if (res.ok) {               // server sent 3xx (e.g., 303 See Other)
                            window.location.reload();
                        }
                        if (!res.ok) {
                            alert(res.status + ' ' + res.statusText);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Save failed: ' + err.message);
                    });
                $(dialogId).dialog('close');
                $(dialogId + ' input').val('');
            });
        }

        init('#chemicalDialog','#addChemical','#saveChemical','#chemicalTable', function(){
            return [$('#chemicalId').val(), $('#chemicalName').val(), $('#chemicalDeviation').val(), $('#chemicalComment').val()];
        }, function(v){
            $('#chemicalId').val(v[0].trim());
            $('#chemicalName').val(v[2].trim());
            $('#chemicalDeviation').val(v[3].trim());
            $('#chemicalComment').val(v[4].trim());
        }, '/chemical-form/' + materialId + '/' + stage, function(){
            return {
                id: $('#chemicalId').val(),
                compoundName: $('#chemicalName').val(),
                stoichiometryDeviation: parseFloat($('#chemicalDeviation').val() || 0),
                notes: $('#chemicalComment').val()
            };
        });
    });
</script>
</body>
</html>
