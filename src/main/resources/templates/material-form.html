<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout (~{::body},'index')}">
<body>
<div class="kt-container-fluid px=0">
    <div class="grid grid-cols-1 gap-5">

        <div th:replace="~{cards/general-info :: generalInfoCard}"></div>

        <th:block th:if="${stage == 1}">
            <div th:replace="~{cards/geology :: geologyCard}"></div>
        </th:block>

        <th:block th:if="${stage == 1}">
            <div th:replace="~{cards/mineralogy :: mineralogyCard}"></div>
        </th:block>

        <th:block th:if="${stage == 2 or stage == 3}">
            <div th:replace="~{cards/chemical-form :: chemicalCard}"></div>
        </th:block>

        <div th:replace="~{cards/element :: elementCard}"></div>
        <div th:replace="~{cards/isotope :: isotopeCard}"></div>
        <div th:replace="~{cards/morphology :: morphologyCard}"></div>
        <div th:replace="~{cards/decay :: decayCard}"></div>
        <div th:replace="~{cards/container :: containerCard}"></div>
        <div th:replace="~{cards/irradiation :: irradiationCard}"></div>
        <div th:replace="~{cards/isotope-activity :: isotopeActivityCard}"></div>
        <div th:replace="~{cards/physical :: physicalCard}"></div>
        <div th:replace="~{cards/process-info :: processInfoCard}"></div>
        <div th:replace="~{cards/serial-number :: serialNumberCard}"></div>
        <div th:replace="~{cards/source-activity-info :: sourceActivityInfoCard}"></div>
        <div th:replace="~{cards/source-description :: sourceDescriptionCard}"></div>

    </div>
</div>

<div th:replace="~{dialogs/chemical-form :: chemicalDialog}"></div>
<div th:replace="~{dialogs/element :: elementDialog}"></div>
<div th:replace="~{dialogs/isotope :: isotopeDialog}"></div>
<div th:replace="~{dialogs/morphology :: morphologyDialog}"></div>
<div th:replace="~{dialogs/decay :: decayDialog}"></div>
<div th:replace="~{dialogs/container :: containerDialog}"></div>
<div th:replace="~{dialogs/general-info :: generalInfoDialog}"></div>
<div th:replace="~{dialogs/geology :: geologyDialog}"></div>
<div th:replace="~{dialogs/irradiation :: irradiationDialog}"></div>
<div th:replace="~{dialogs/isotope-activity :: isotopeActivityDialog}"></div>
<div th:replace="~{dialogs/mineralogy :: mineralogyDialog}"></div>
<div th:replace="~{dialogs/physical :: physicalDialog}"></div>
<div th:replace="~{dialogs/process-info :: processInfoDialog}"></div>
<div th:replace="~{dialogs/serial-number :: serialNumberDialog}"></div>
<div th:replace="~{dialogs/source-activity-info :: sourceActivityInfoDialog}"></div>
<div th:replace="~{dialogs/source-description :: sourceDescriptionDialog}"></div>


<link rel="stylesheet" th:href="@{https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css}" />
<script th:src="@{https://code.jquery.com/jquery-3.7.1.min.js}"></script>
<script th:src="@{https://code.jquery.com/ui/1.13.2/jquery-ui.js}"></script>
<script>
    $(function(){
        var materialId = window.location.pathname.split('/')[3];
        var stage = window.location.pathname.split('/')[4];
        var csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        var csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

        function init(dialogId, addBtnId, saveBtnId, tableId, getData, setData, endpoint, getJsonData){
            var currentRow = null;
            $(dialogId).dialog({ autoOpen:false, modal:true, width:640 });
            $(addBtnId).click(function(){ currentRow=null; $(dialogId).dialog('open'); });
            $(tableId).on('click','.editRow', function(){
                currentRow = $(this).closest('tr');
                var values = currentRow.children('td').slice(0,-1).map(function(){ return $(this).text(); }).get();
                setData(values);
                $(dialogId).dialog('open');
            });
            $(saveBtnId).click(function(){
                var data = getData();
                var payload = getJsonData ? getJsonData() : data;
                var headers = {'Content-Type':'application/json'};
                if (csrfToken) {
                    headers[csrfHeader || 'X-CSRF-TOKEN'] = csrfToken;
                }
                fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload),
                    credentials: 'same-origin'
                })
                    .then(res => {
                        if (res.ok) {               // server sent 3xx (e.g., 303 See Other)
                            window.location.reload();
                        }
                        if (!res.ok) {
                            alert(res.status + ' ' + res.statusText);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Save failed: ' + err.message);
                    });
                $(dialogId).dialog('close');
                $(dialogId + ' input').val('');
            });
        }

        init('#chemicalDialog','#addChemical','#saveChemical','#chemicalTable', function(){
            return [$('#chemicalId').val(), $('#chemicalName').val(), $('#chemicalDeviation').val(), $('#chemicalComment').val()];
        }, function(v){
            $('#chemicalId').val(v[0].trim());
            $('#chemicalName').val(v[2].trim());
            $('#chemicalDeviation').val(v[3].trim());
            $('#chemicalComment').val(v[4].trim());
        }, '/chemical-form/' + materialId + '/' + stage, function(){
            return {
                id: $('#chemicalId').val(),
                compoundName: $('#chemicalName').val(),
                stoichiometryDeviation: parseFloat($('#chemicalDeviation').val() || 0),
                notes: $('#chemicalComment').val()
            };
        });

        init('#elementDialog','#addElement','#saveElement','#elementTable', function(){
            return [$('#elementName').val(), $('#elementConcentration').val(), $('#elementUncertainty').val(), $('#elementComment').val()];
        }, function(v){
            $('#elementName').val(v[0].trim());
            $('#elementConcentration').val(v[1].trim());
            $('#elementUncertainty').val(v[2].trim());
            $('#elementComment').val(v[3].trim());
        }, '/element/' + materialId + '/' + stage, function(){
            return {
                element: $('#elementName').val(),
                concentration: parseFloat($('#elementConcentration').val() || 0),
                uncertainty: parseFloat($('#elementUncertainty').val() || 0),
                notes: $('#elementComment').val()
            };
        });

        init('#isotopeDialog','#addIsotope','#saveIsotope','#isotopeTable', function(){
            return [$('#isotopeName').val(), $('#isotopeRatio').val(), $('#isotopeUncertainty').val(), $('#isotopeComment').val()];
        }, function(v){
            $('#isotopeName').val(v[0].trim());
            $('#isotopeRatio').val(v[1].trim());
            $('#isotopeUncertainty').val(v[2].trim());
            $('#isotopeComment').val(v[3].trim());
        }, '/isotope/' + materialId + '/' + stage, function(){
            return {
                name: $('#isotopeName').val(),
                value: parseFloat($('#isotopeRatio').val() || 0),
                uncertainty: parseFloat($('#isotopeUncertainty').val() || 0),
                notes: $('#isotopeComment').val()
            };
        });

        init('#morphologyDialog','#addMorphology','#saveMorphology','#morphologyTable', function(){
            return [$('#morphCrystal').val(), $('#morphA').val(), $('#morphB').val(), $('#morphComment').val()];
        }, function(v){
            $('#morphCrystal').val(v[0].trim());
            $('#morphA').val(v[1].trim());
            $('#morphB').val(v[2].trim());
            $('#morphComment').val(v[3].trim());
        }, '/morphology/' + materialId + '/' + stage, function(){
            return {
                latticeStructure: $('#morphCrystal').val(),
                aspectRatio: parseFloat($('#morphA').val() || 0),
                porosity: parseFloat($('#morphB').val() || 0),
                notes: $('#morphComment').val()
            };
        });

        init('#decayDialog','#addDecay','#saveDecay','#decayTable', function(){
            return [$('#decayNuclide').val(), $('#decayActivity').val(), $('#decayComment').val()];
        }, function(v){
            $('#decayNuclide').val(v[0].trim());
            $('#decayActivity').val(v[1].trim());
            $('#decayComment').val(v[2].trim());
        }, '/decay/' + materialId + '/' + stage, function(){
            return {
                isotopeName: $('#decayNuclide').val(),
                activityBq: parseFloat($('#decayActivity').val() || 0),
                notes: $('#decayComment').val()
            };
        });

        init('#containerDialog','#addContainer','#saveContainer','#containerTable', function(){
            return [$('#containerType').val(), $('#containerVolume').val(), $('#containerSerial').val(), $('#containerNotes').val()];
        }, function(v){
            $('#containerType').val(v[0].trim());
            $('#containerVolume').val(v[1].trim());
            $('#containerSerial').val(v[2].trim());
            $('#containerNotes').val(v[3].trim());
        }, '/container/' + materialId + '/' + stage, function(){
            return {
                type: $('#containerType').val(),
                volume: parseFloat($('#containerVolume').val() || 0),
                serialNumber: $('#containerSerial').val(),
                notes: $('#containerNotes').val()
            };
        });

        init('#generalInfoDialog','#addGeneralInfo','#saveGeneralInfo','#generalInfoTable', function(){
            return [
                $('#generalId').val(),
                $('#generalDataRecordDate').val(),
                $('#generalCustodian').val(),
                $('#generalLab').val(),
                $('#generalAnalysisDate').val(),
                $('#generalCountry').val(),
                $('#generalProducer').val(),
                $('#generalSupplier').val(),
                $('#generalBatchId').val(),
                $('#generalBatchProcessDate').val(),
                $('#generalShipperCarrier').val(),
                $('#generalReceiverInfo').val(),
                $('#generalShippingDate').val(),
                $('#generalReceivingDate').val(),
                $('#generalDataEvaluationInfo').val(),
                $('#generalVariationRangeNotes').val(),
                $('#generalInformationAcquisitionDate').val(),
                $('#generalUsedArchivedInformation').is(':checked'),
                $('#generalNotes').val()
            ];
        }, function(v){
            $('#generalId').val(v[0].trim());
            $('#generalDataRecordDate').val(v[2].trim());
            $('#generalCustodian').val(v[3].trim());
            $('#generalLab').val(v[4].trim());
            $('#generalAnalysisDate').val(v[5].trim());
            $('#generalCountry').val(v[6].trim());
            $('#generalProducer').val(v[7].trim());
            $('#generalSupplier').val(v[8].trim());
            $('#generalBatchId').val(v[9].trim());
            $('#generalBatchProcessDate').val(v[10].trim());
            $('#generalShipperCarrier').val(v[11].trim());
            $('#generalReceiverInfo').val(v[12].trim());
            $('#generalShippingDate').val(v[13].trim());
            $('#generalReceivingDate').val(v[14].trim());
            $('#generalDataEvaluationInfo').val(v[15].trim());
            $('#generalVariationRangeNotes').val(v[16].trim());
            $('#generalInformationAcquisitionDate').val(v[17].trim());
            $('#generalUsedArchivedInformation').prop('checked', v[18].trim().toLowerCase() === 'true');
            $('#generalNotes').val(v[19].trim());
        }, '/general-info/' + materialId + '/' + stage, function(){
            return {
                id: $('#generalId').val(),
                dataRecordDate: $('#generalDataRecordDate').val(),
                custodian: $('#generalCustodian').val(),
                analyticalLab: $('#generalLab').val(),
                analysisDate: $('#generalAnalysisDate').val(),
                countryOfOrigin: $('#generalCountry').val(),
                producer: $('#generalProducer').val(),
                supplier: $('#generalSupplier').val(),
                batchId: $('#generalBatchId').val(),
                batchProcessDate: $('#generalBatchProcessDate').val(),
                shipperCarrier: $('#generalShipperCarrier').val(),
                receiverInfo: $('#generalReceiverInfo').val(),
                shippingDate: $('#generalShippingDate').val(),
                receivingDate: $('#generalReceivingDate').val(),
                dataEvaluationInfo: $('#generalDataEvaluationInfo').val(),
                variationRangeNotes: $('#generalVariationRangeNotes').val(),
                informationAcquisitionDate: $('#generalInformationAcquisitionDate').val(),
                usedArchivedInformation: $('#generalUsedArchivedInformation').is(':checked'),
                notes: $('#generalNotes').val()
            };
        });

        init('#geologyDialog','#addGeology','#saveGeology','#geologyTable', function(){
            return [$('#geologyLocation').val(), $('#geologyFormation').val(), $('#geologyDeposit').val(), $('#geologyNotes').val()];
        }, function(v){
            $('#geologyLocation').val(v[0].trim());
            $('#geologyFormation').val(v[1].trim());
            $('#geologyDeposit').val(v[2].trim());
            $('#geologyNotes').val(v[3].trim());
        }, '/geology/' + materialId + '/' + stage, function(){
            return {
                mineLocation: $('#geologyLocation').val(),
                geologicalFormation: $('#geologyFormation').val(),
                depositTypes: $('#geologyDeposit').val(),
                notes: $('#geologyNotes').val()
            };
        });

        init('#irradiationDialog','#addIrradiation','#saveIrradiation','#irradiationTable', function(){
            return [$('#irradiationReactor').val(), $('#irradiationBurnUp').val(), $('#irradiationLoadDate').val(), $('#irradiationDischargeDate').val(), $('#irradiationNotes').val()];
        }, function(v){
            $('#irradiationReactor').val(v[0].trim());
            $('#irradiationBurnUp').val(v[1].trim());
            $('#irradiationLoadDate').val(v[2].trim());
            $('#irradiationDischargeDate').val(v[3].trim());
            $('#irradiationNotes').val(v[4].trim());
        }, '/irradiation/' + materialId + '/' + stage, function(){
            return {
                reactorType: $('#irradiationReactor').val(),
                burnUp: $('#irradiationBurnUp').val(),
                loadDate: $('#irradiationLoadDate').val(),
                dischargeDate: $('#irradiationDischargeDate').val(),
                notes: $('#irradiationNotes').val()
            };
        });

        init('#isotopeActivityDialog','#addIsotopeActivity','#saveIsotopeActivity','#isotopeActivityTable', function(){
            return [$('#isotopeActivityName').val(), $('#isotopeActivityValue').val(), $('#isotopeActivityDate').val(), $('#isotopeActivityNotes').val()];
        }, function(v){
            $('#isotopeActivityName').val(v[0].trim());
            $('#isotopeActivityValue').val(v[1].trim());
            $('#isotopeActivityDate').val(v[2].trim());
            $('#isotopeActivityNotes').val(v[3].trim());
        }, '/isotope-activity/' + materialId + '/' + stage, function(){
            return {
                isotopeName: $('#isotopeActivityName').val(),
                activityBq: parseFloat($('#isotopeActivityValue').val() || 0),
                referenceDate: $('#isotopeActivityDate').val(),
                notes: $('#isotopeActivityNotes').val()
            };
        });

        init('#mineralogyDialog','#addMineralogy','#saveMineralogy','#mineralogyTable', function(){
            return [$('#mineralogyMinerals').val(), $('#mineralogyVolume').val(), $('#mineralogyNotes').val()];
        }, function(v){
            $('#mineralogyMinerals').val(v[0].trim());
            $('#mineralogyVolume').val(v[1].trim());
            $('#mineralogyNotes').val(v[2].trim());
        }, '/mineralogy/' + materialId + '/' + stage, function(){
            return {
                mineralsPresent: $('#mineralogyMinerals').val(),
                volumePercentages: parseFloat($('#mineralogyVolume').val() || 0),
                notes: $('#mineralogyNotes').val()
            };
        });

        init('#physicalDialog','#addPhysical','#savePhysical','#physicalTable', function(){
            return [$('#physicalState').val(), $('#physicalDescription').val(), $('#physicalMass').val(), $('#physicalNotes').val()];
        }, function(v){
            $('#physicalState').val(v[0].trim());
            $('#physicalDescription').val(v[1].trim());
            $('#physicalMass').val(v[2].trim());
            $('#physicalNotes').val(v[3].trim());
        }, '/physical/' + materialId + '/' + stage, function(){
            return {
                stateOfMatter: $('#physicalState').val(),
                description: $('#physicalDescription').val(),
                mass: parseFloat($('#physicalMass').val() || 0),
                notes: $('#physicalNotes').val()
            };
        });

        init('#processInfoDialog','#addProcessInfo','#saveProcessInfo','#processInfoTable', function(){
            return [$('#processType').val(), $('#processLocation').val(), $('#processStart').val(), $('#processEnd').val(), $('#processNotes').val()];
        }, function(v){
            $('#processType').val(v[0].trim());
            $('#processLocation').val(v[1].trim());
            $('#processStart').val(v[2].trim());
            $('#processEnd').val(v[3].trim());
            $('#processNotes').val(v[4].trim());
        }, '/process-info/' + materialId + '/' + stage, function(){
            return {
                processTypeOrDescription: $('#processType').val(),
                locationOfProcessingSite: $('#processLocation').val(),
                startDate: $('#processStart').val(),
                endDate: $('#processEnd').val(),
                notes: $('#processNotes').val()
            };
        });

        init('#serialNumberDialog','#addSerialNumber','#saveSerialNumber','#serialNumberTable', function(){
            return [$('#serialNumberValue').val(), $('#serialNumberNotes').val()];
        }, function(v){
            $('#serialNumberValue').val(v[0].trim());
            $('#serialNumberNotes').val(v[1].trim());
        }, '/serial-number/' + materialId + '/' + stage, function(){
            return {
                serialNumber: $('#serialNumberValue').val(),
                notes: $('#serialNumberNotes').val()
            };
        });

        init('#sourceActivityInfoDialog','#addSourceActivityInfo','#saveSourceActivityInfo','#sourceActivityInfoTable', function(){
            return [$('#sourceActivityValue').val(), $('#sourceActivityDate').val(), $('#sourceActivityNeutron').val(), $('#sourceActivityNotes').val()];
        }, function(v){
            $('#sourceActivityValue').val(v[0].trim());
            $('#sourceActivityDate').val(v[1].trim());
            $('#sourceActivityNeutron').val(v[2].trim());
            $('#sourceActivityNotes').val(v[3].trim());
        }, '/source-activity-info/' + materialId + '/' + stage, function(){
            return {
                activityBq: parseFloat($('#sourceActivityValue').val() || 0),
                referenceDate: $('#sourceActivityDate').val(),
                neutronIntensityPerSec: $('#sourceActivityNeutron').val(),
                notes: $('#sourceActivityNotes').val()
            };
        });

        init('#sourceDescriptionDialog','#addSourceDescription','#saveSourceDescription','#sourceDescriptionTable', function(){
            return [$('#sourceDescriptionType').val(), $('#sourceDescriptionQuantity').val(), $('#sourceDescriptionSerial').val(), $('#sourceDescriptionNotes').val()];
        }, function(v){
            $('#sourceDescriptionType').val(v[0].trim());
            $('#sourceDescriptionQuantity').val(v[1].trim());
            $('#sourceDescriptionSerial').val(v[2].trim());
            $('#sourceDescriptionNotes').val(v[3].trim());
        }, '/source-description/' + materialId + '/' + stage, function(){
            return {
                sourceType: $('#sourceDescriptionType').val(),
                quantity: $('#sourceDescriptionQuantity').val(),
                serialNumber: $('#sourceDescriptionSerial').val(),
                notes: $('#sourceDescriptionNotes').val()
            };
        });
    });
</script>
</body>
</html>
