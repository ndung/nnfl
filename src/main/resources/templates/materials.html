<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout (~{::body},'index')}">
<body>
<div class="kt-container-fluid px=0">
    <div class="kt-card">
        <div class="kt-card-header flex justify-between">
            <h3 class="kt-card-title">Material Records</h3>
            <form id="createMaterialForm" th:action="@{|/materials|}" method="post">
                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="id" id="newMaterialId" />
                <input type="hidden" name="name" id="newMaterialName" />
                <button type="button" id="openCreateMaterialDialog"
                        class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost"><i class="ki-filled ki-additem"></i></button>
            </form>
        </div>
        <!-- Alerts -->
        <div class="kt-badge kt-badge-sm kt-badge-success kt-badge-outline" th:if="${materialSaved}">
            Material record saved successfully.
        </div>
        <div class="kt-badge kt-badge-sm kt-badge-success kt-badge-outline" th:if="${materialDeleted}">
            Material record deleted successfully.
        </div>
        <div th:if="${materialExist}" class="kt-badge kt-badge-sm kt-badge-warning kt-badge-outline">Material record has been created.</div>

        <div class="kt-card-content">
            <link rel="stylesheet" th:href="@{https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css}" />
            <link rel="stylesheet" th:href="@{https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css}" />
            <div class="table-responsive">
                <table id="materialsTable" class="display table w-full min-w-[600px] text-xs">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Creator</th>
                        <th>Creation Date</th>
                        <th>Data</th>
                        <th>Edit</th>
                        <th>Delete</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="m : ${materials}">
                        <td th:text="${m.id}">1</td>
                        <td th:text="${m.name}"></td>
                        <td th:text="${m.creator != null ? m.creator.username : ''}">alice</td>
                        <td th:text="${#dates.format(m.creationDateTime, 'yyyy-MM-dd HH:mm:ss')}">2023-01-01</td>
                        <td th:text="${m.data.length()<200 ? m.data : m.data.substring(0,200)+'...'}">1</td>
                        <td>
                        <button class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost editMaterialBtn" th:data-id="${m.id}">
                            <i class="ki-filled ki-notepad-edit">
                            </i>
                        </button>
                        </td>
                        <td>
                        <form th:action="@{|/materials/${m.id}/delete|}" method="post"
                              onsubmit="return confirm('Delete this record?');">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost"><i class="ki-filled ki-trash">
                            </i></button>
                        </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="materialIdDialog" title="Create Material Record" style="display:none;">
            <div class="grid gap-3 text-xs">
                <label class="grid gap-1">
                    <span class="font-semibold">Material ID</span>
                    <input type="text" id="materialIdInput" class="kt-input" placeholder="Enter material ID" />
                </label>
                <div id="materialIdError" class="text-xs" style="display:none;color:#dc2626;">Please enter a material ID.</div>
                <label class="grid gap-1">
                    <span class="font-semibold">Material Name</span>
                    <input type="text" id="materialNameInput" class="kt-input" placeholder="Enter material name" />
                </label>
                <div id="materialNameError" class="text-xs" style="display:none;color:#dc2626;">Please enter a material name.</div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="materialIdSubmitBtn" class="kt-btn kt-btn-primary">Create</button>
                </div>
            </div>
        </div>
        <div id="stageDialog" title="Select Stage" style="display:none;">
            <div class="grid gap-5 text-xs">
                <select id="stageSelect" class="kt-input">
                    <option th:each="t : ${typeOptions}" th:value="${t.key}" th:text="${t.value}"></option>
                </select>
                <div class="flex justify-end gap-2">
                    <button type="button" id="stageSelectBtn" class="kt-btn kt-btn-primary">Select</button>
                    <button type="button" class="kt-btn" onclick="$('#stageDialog').dialog('close');">Cancel</button>
                </div>
            </div>
        </div>

        <script th:src="@{https://code.jquery.com/jquery-3.7.1.min.js}"></script>
        <script th:src="@{https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js}"></script>
        <script th:src="@{https://code.jquery.com/ui/1.13.2/jquery-ui.js}"></script>
        <script>
            $(function(){
                $('#materialsTable').DataTable({
                    scrollX: true,
                    autoWidth: false,
                    columnDefs: [ { targets: '_all', className: 'whitespace-nowrap' } ]
                });

                var createMaterialForm = $('#createMaterialForm');
                var newMaterialIdField = $('#newMaterialId');
                var newMaterialNameField = $('#newMaterialName');
                var materialIdInput = $('#materialIdInput');
                var materialNameInput = $('#materialNameInput');
                var materialIdError = $('#materialIdError');
                var materialNameError = $('#materialNameError');
                var materialIdDialog = $('#materialIdDialog').dialog({
                    autoOpen: false,
                    modal: true,
                    width: 400,
                    open: function(){
                        materialIdInput.val('');
                        newMaterialIdField.val('');
                        materialNameInput.val('');
                        newMaterialNameField.val('');
                        materialIdError.hide();
                        materialNameError.hide();
                        setTimeout(function(){ materialIdInput.trigger('focus'); }, 0);
                    }
                });

                createMaterialForm.on('submit', function(e){
                    if(!$.trim(newMaterialIdField.val())){
                        e.preventDefault();
                        materialIdDialog.dialog('open');
                    }
                });

                $('#openCreateMaterialDialog').on('click', function(e){
                    e.preventDefault();
                    materialIdDialog.dialog('open');
                });

                $('#materialIdSubmitBtn').on('click', function(){
                    var enteredId = $.trim(materialIdInput.val());
                    var enteredName = $.trim(materialNameInput.val());
                    if(!enteredId){
                        materialIdError.show();
                        materialIdInput.trigger('focus');
                        return;
                    }
                    materialIdError.hide();
                    if(!enteredName){
                        materialNameError.show();
                        materialNameInput.trigger('focus');
                        return;
                    }
                    materialNameError.hide();
                    materialIdError.hide();
                    newMaterialIdField.val(enteredId);
                    newMaterialNameField.val(enteredName);
                    materialIdDialog.dialog('close');
                    createMaterialForm.trigger('submit');
                });

                materialIdInput.on('keypress', function(e){
                    if(e.which === 13){
                        e.preventDefault();
                        $('#materialIdSubmitBtn').click();
                    }
                });

                materialNameInput.on('keypress', function(e){
                    if(e.which === 13){
                        e.preventDefault();
                        $('#materialIdSubmitBtn').click();
                    }
                });

                var stageDialog = $('#stageDialog').dialog({ autoOpen: false, modal: true, width: 400 });
                var materialId;

                $('.editMaterialBtn').on('click', function(){
                    materialId = $(this).data('id');
                    stageDialog.dialog('open');
                });

                $('#stageSelectBtn').on('click', function(){
                    var stage = $('#stageSelect').val();
                    if(stage){
                        var url = /*[[@{/materials}]]*/ '/materials';
                        window.location.href = url + '/' + materialId + '/' + stage;
                    }
                });
            });
        </script>
    </div>
</div>
</body>
</html>
